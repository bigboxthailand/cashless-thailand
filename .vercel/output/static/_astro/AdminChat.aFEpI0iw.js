import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r as n}from"./index.WFquGv8Z.js";import{s as i}from"./supabase.B9bYqD4q.js";import"./index.DR2MMlUt.js";function M(){const[d,h]=n.useState([]),[a,x]=n.useState(null),[u,m]=n.useState([]),[l,f]=n.useState(""),[N,_]=n.useState(!0),p=n.useRef(null);n.useEffect(()=>{g();const e=i.channel("admin_conversations").on("postgres_changes",{event:"INSERT",schema:"public",table:"conversations"},()=>g()).subscribe();return()=>i.removeChannel(e)},[]),n.useEffect(()=>{if(a){y(a);const e=k(a);return()=>i.removeChannel(e)}},[a]),n.useEffect(()=>{p.current?.scrollIntoView({behavior:"smooth"})},[u]);const[b,v]=n.useState({});n.useEffect(()=>{a&&w(a)},[a]);const g=async()=>{try{const{data:e,error:s}=await i.from("conversations").select(`
                    id, updated_at, type,
                    conversation_participants (
                        user_id,
                        profiles ( full_name, email )
                    )
                `).eq("type","support").order("updated_at",{ascending:!1});if(s)throw s;h(e||[]);const{data:r}=await i.from("messages").select("conversation_id").eq("is_read",!1).eq("is_admin",!1);if(r){const o={};r.forEach(c=>{o[c.conversation_id]=(o[c.conversation_id]||0)+1}),v(o)}}catch(e){console.error("Error fetching conversations:",e)}finally{_(!1)}},y=async e=>{const{data:s,error:r}=await i.from("messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});s&&m(s)},k=e=>i.channel(`admin_chat:${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},s=>{m(r=>[...r,s.new]),s.new.is_admin||w(e)}).subscribe(),w=async e=>{v(s=>({...s,[e]:0})),await i.from("messages").update({is_read:!0}).eq("conversation_id",e).eq("is_read",!1).eq("is_admin",!1)},C=async e=>{if(e.preventDefault(),!l.trim()||!a)return;const s=l.trim();f("");try{const{data:{session:r}}=await i.auth.getSession(),o=r?.user?.id||null,{error:c}=await i.from("messages").insert([{conversation_id:a,sender_id:o,content:s,is_admin:!0}]);if(c)throw c}catch(r){console.error("Error sending message:",r),alert("Failed to send")}},A=async(e,s)=>{if(e.stopPropagation(),!!confirm("Are you sure you want to delete this conversation? This cannot be undone."))try{const{error:r}=await i.from("conversations").delete().eq("id",s);if(r)throw r;h(o=>o.filter(c=>c.id!==s)),a===s&&x(null)}catch(r){console.error("Error deleting conversation:",r),alert("Failed to delete conversation")}},j=e=>{if(!e||!e.conversation_participants)return"Unknown User";const s=e.conversation_participants.find(r=>r.user_id!==null);return s?.profiles?.full_name||s?.profiles?.email||"Unknown User"};return t.jsxs("div",{className:"flex h-[calc(100vh-120px)] bg-[#111] border border-white/10 rounded-xl overflow-hidden shadow-2xl",children:[t.jsxs("div",{className:"w-1/3 border-r border-white/10 bg-[#0A0A0A] flex flex-col",children:[t.jsx("div",{className:"p-4 border-b border-white/10",children:t.jsx("h2",{className:"text-white font-bold uppercase tracking-wider text-sm",children:"Active Chats"})}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:N?t.jsx("div",{className:"p-4 text-white/30 text-center text-sm",children:"Loading..."}):d.length===0?t.jsx("div",{className:"p-4 text-white/30 text-center text-sm",children:"No active chats"}):d.map(e=>t.jsxs("div",{onClick:()=>x(e.id),className:`relative w-full text-left p-4 border-b border-white/5 hover:bg-white/5 transition-colors cursor-pointer group ${a===e.id?"bg-[#D4AF37]/10 border-l-4 border-l-[#D4AF37]":""}`,children:[t.jsxs("div",{className:"flex justify-between items-start mb-1 pr-6",children:[t.jsx("span",{className:`font-bold text-sm ${a===e.id?"text-[#D4AF37]":"text-white"}`,children:j(e)}),b[e.id]>0&&t.jsx("span",{className:"ml-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full",children:b[e.id]}),t.jsx("span",{className:"text-[10px] text-white/30 ml-auto",children:new Date(e.updated_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),t.jsx("div",{className:"text-xs text-white/50 truncate",children:"Click to view conversation"}),t.jsx("button",{onClick:s=>A(s,e.id),className:"absolute right-2 top-1/2 -translate-y-1/2 p-2 text-white/20 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all",title:"Delete Conversation",children:t.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M3 6h18"}),t.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),t.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]})})]},e.id))})]}),t.jsx("div",{className:"flex-1 flex flex-col bg-[#111]",children:a?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"p-4 border-b border-white/10 bg-[#161616] flex justify-between items-center",children:[t.jsxs("h3",{className:"text-white font-bold",children:["Chat with ",t.jsx("span",{className:"text-[#D4AF37]",children:j(d.find(e=>e.id===a))})]}),t.jsx("span",{className:"px-2 py-1 bg-green-500/10 text-green-500 text-xs rounded border border-green-500/20",children:"Live"})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[u.map(e=>{const s=e.is_admin;return t.jsx("div",{className:`flex ${s?"justify-end":"justify-start"}`,children:t.jsxs("div",{className:`max-w-[70%] rounded-2xl p-3 text-sm ${s?"bg-[#D4AF37] text-black rounded-tr-none":"bg-white/10 text-white rounded-tl-none"}`,children:[e.metadata?.order_id&&t.jsxs("div",{className:"mb-2 bg-black/20 rounded p-2 flex items-center gap-2 cursor-pointer hover:bg-black/40 transition-colors",onClick:()=>window.open(`/admin/orders?search=${e.metadata.order_id}`,"_blank"),children:[t.jsx("div",{className:"w-8 h-8 bg-[#D4AF37] rounded flex items-center justify-center text-black font-bold text-xs",children:"ORD"}),t.jsxs("div",{children:[t.jsxs("p",{className:"font-bold text-xs",children:["Order #",e.metadata.order_id.slice(0,8)]}),t.jsx("p",{className:"text-[10px] opacity-70",children:"Click to view details"})]})]}),e.attachment_url&&t.jsx("div",{className:"mb-2 rounded-lg overflow-hidden border border-black/10",children:t.jsx("img",{src:e.attachment_url,alt:"Attachment",className:"max-w-[200px] max-h-[200px] object-cover"})}),t.jsx("p",{children:e.content}),t.jsx("div",{className:`text-[10px] mt-1 opacity-50 ${s?"text-black":"text-white"}`,children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},e.id)}),t.jsx("div",{ref:p})]}),t.jsx("form",{onSubmit:C,className:"p-4 bg-[#161616] border-t border-white/10",children:t.jsxs("div",{className:"flex gap-4",children:[t.jsx("input",{type:"text",value:l,onChange:e=>f(e.target.value),placeholder:"Type your reply...",className:"flex-1 bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-[#D4AF37]"}),t.jsx("button",{type:"submit",disabled:!l.trim(),className:"px-6 py-2 bg-[#D4AF37] text-black font-bold rounded-lg hover:bg-white transition-colors disabled:opacity-50",children:"Send"})]})})]}):t.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-white/30",children:[t.jsx("svg",{className:"w-16 h-16 mb-4 opacity-50",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"1",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),t.jsx("p",{children:"Select a conversation to start chatting"})]})})]})}export{M as default};
