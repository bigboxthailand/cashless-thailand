import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as n}from"./index.WFquGv8Z.js";import{s as o}from"./supabase.B9bYqD4q.js";import"./index.DR2MMlUt.js";function E(){const[l,u]=n.useState(!1),[h,d]=n.useState([]),[c,f]=n.useState(""),[i,w]=n.useState(null),[a,p]=n.useState(null),[x,m]=n.useState(!1),[j,v]=n.useState(!1),b=n.useRef(null);n.useEffect(()=>{o.auth.getSession().then(({data:{session:t}})=>{w(t),t&&N(t.user.id)})},[]),n.useEffect(()=>{if(a){const t=o.channel(`chat:${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${a}`},s=>{d(r=>[...r,s.new]),g(),l||v(!0)}).subscribe();return()=>{o.removeChannel(t)}}},[a,l]);const g=()=>{setTimeout(()=>b.current?.scrollIntoView({behavior:"smooth"}),100)},N=async t=>{const{data:s}=await o.from("conversation_participants").select("conversation_id, conversation:conversations(id, type)").eq("user_id",t),r=s?.find(_=>_.conversation?.type==="support");r&&(p(r.conversation.id),y(r.conversation.id))},y=async t=>{const{data:s}=await o.from("messages").select("*").eq("conversation_id",t).order("created_at",{ascending:!0});d(s||[]),g()},k=async()=>{if(!i){window.location.href="/login";return}m(!0);const{data:t,error:s}=await o.from("conversations").insert({type:"support",title:"Support Chat"}).select().single();t&&(await o.from("conversation_participants").insert({conversation_id:t.id,user_id:i.user.id}),p(t.id),d([])),m(!1)},S=async t=>{if(t.preventDefault(),!c.trim()||!a||!i)return;const s=c.trim();f("");const{error:r}=await o.from("messages").insert({conversation_id:a,sender_id:i.user.id,content:s});r&&console.error("Send failed",r)};return i?e.jsxs("div",{className:"fixed bottom-6 right-6 z-50",children:[!l&&e.jsxs("button",{onClick:()=>{u(!0),v(!1)},className:"w-14 h-14 bg-[#D4AF37] hover:bg-white rounded-full shadow-[0_0_20px_rgba(212,175,55,0.4)] flex items-center justify-center transition-all hover:scale-110 active:scale-90 group relative",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-6 h-6 text-black",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"})}),j&&e.jsxs("span",{className:"absolute top-0 right-0 -mt-1 -mr-1 flex h-3 w-3",children:[e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex rounded-full h-3 w-3 bg-red-500"})]})]}),l&&e.jsxs("div",{className:"w-[350px] h-[500px] bg-[#111] border border-white/20 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in-up",children:[e.jsxs("div",{className:"bg-[#0a0a0a] p-4 border-b border-white/10 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500 animate-pulse"}),e.jsx("h3",{className:"font-bold text-white",children:"Support"})]}),e.jsx("button",{onClick:()=>u(!1),className:"text-white/50 hover:text-white",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-black/50",children:[a?h.length===0?e.jsx("p",{className:"text-center text-white/30 text-xs mt-10",children:"Start the conversation..."}):h.map(t=>{const s=t.sender_id===i.user.id;return e.jsx("div",{className:`flex ${s?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[80%] px-4 py-2 rounded-2xl text-sm ${s?"bg-[#D4AF37] text-black rounded-tr-none":"bg-white/10 text-white rounded-tl-none"}`,children:t.content})},t.id)}):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-center space-y-4",children:[e.jsx("p",{className:"text-white/60 text-sm",children:"Need help with an order?"}),e.jsx("button",{onClick:k,disabled:x,className:"px-6 py-2 bg-[#D4AF37] text-black font-bold rounded-full hover:scale-105 transition-transform",children:x?"Starting...":"Start Chat"})]}),e.jsx("div",{ref:b})]}),a&&e.jsxs("form",{onSubmit:S,className:"p-4 bg-[#0a0a0a] border-t border-white/10 flex gap-2",children:[e.jsx("input",{value:c,onChange:t=>f(t.target.value),placeholder:"Type a message...",className:"flex-1 bg-white/5 border border-white/10 rounded-full px-4 py-2 text-white text-sm focus:border-[#D4AF37] outline-none"}),e.jsx("button",{type:"submit",disabled:!c.trim(),className:"bg-[#D4AF37] text-black p-2 rounded-full hover:scale-110 disabled:opacity-50 disabled:scale-100 transition-all",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})]})]}):null}export{E as default};
