import{c as V}from"./cartStore.IpiDG6ld.js";import{s as b}from"./supabase.B9bYqD4q.js";import"./index.DR2MMlUt.js";function D(){const S=document.getElementById("product-page-container");if(!S)return;const i=JSON.parse(S.dataset.productJson||"{}"),l=i.media?.gallery||[i.media?.mainImage];let A="Standard",y=l[0],w=i.pricing?.basePrice;i.config&&i.config.variants&&i.config.variants.length>0&&(A=i.config.variants[0].name,y=i.config.variants[0].image||y,w=i.config.variants[0].price||w);const r={currentImage:y,selectedVariantName:A,currentPrice:w,compositeSelection:{}};i.config?.variantType==="composite"&&i.config.options.forEach((e,t)=>{r.compositeSelection[t]=0});const I=e=>{const t=document.getElementById(e);if(!t)return null;const n=t.cloneNode(!0);return t.parentNode&&t.parentNode.replaceChild(n,t),n},N=document.getElementById("image-container"),v=document.getElementById("main-image"),u=document.getElementById("price-display"),p=document.getElementById("qty-input"),F=I("qty-minus"),_=I("qty-plus"),g=I("add-to-cart-btn"),B=document.querySelectorAll(".variant-btn"),k=document.querySelectorAll(".thumbnail-btn"),h=e=>{!v||!e||r.currentImage===e||(v.style.opacity="0",v.style.transform="scale(0.95)",setTimeout(()=>{v.src=e,v.style.opacity="1",v.style.transform="scale(1)",r.currentImage=e,q(e)},200))},q=e=>{document.querySelectorAll(".thumbnail-btn").forEach(t=>{const n=t,s=n.dataset.src===e,a=n.querySelector("img");s?(n.classList.remove("border-white/10"),n.classList.add("border-[#D4AF37]"),a&&(a.classList.remove("opacity-60"),a.classList.add("opacity-100"))):(n.classList.remove("border-[#D4AF37]"),n.classList.add("border-white/10"),a&&(a.classList.add("opacity-60"),a.classList.remove("opacity-100")))})};let x=0,E=0;const C=()=>{if(l.length<=1)return;const e=l.indexOf(r.currentImage);if(E<x-50){const t=(e+1)%l.length;h(l[t])}if(E>x+50){const t=(e-1+l.length)%l.length;h(l[t])}};N?.addEventListener("touchstart",e=>{x=e.changedTouches[0].screenX},{passive:!0}),N?.addEventListener("touchend",e=>{E=e.changedTouches[0].screenX,C()},{passive:!0}),k.forEach(e=>{const t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e),t.addEventListener("click",n=>{const s=n.currentTarget;s.dataset.src&&h(s.dataset.src)})}),B.forEach((e,t)=>{const n=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(n,e),t===0&&(n.classList.contains("rounded-full")?(n.classList.add("border-[#D4AF37]","scale-110","active-variant"),n.classList.remove("border-white/20")):(n.classList.add("bg-[#D4AF37]","text-black","border-[#D4AF37]","active-variant"),n.classList.remove("border-white/10","text-white/60"))),n.addEventListener("click",s=>{const a=s.currentTarget,o=a.dataset.name||"",d=a.dataset.image,f=a.dataset.price||"0",c=parseInt(f);r.selectedVariantName=o,r.currentPrice=c,d&&h(d),u&&!isNaN(c)&&(u.innerText=c.toLocaleString(),u.classList.add("scale-110","text-[#D4AF37]"),setTimeout(()=>u.classList.remove("scale-110","text-[#D4AF37]"),150)),document.querySelectorAll(".variant-btn").forEach(L=>{const m=L;m.classList.contains("rounded-full")?(m.classList.remove("border-[#D4AF37]","scale-110","active-variant"),m.classList.add("border-white/20")):(m.classList.remove("bg-[#D4AF37]","text-black","border-[#D4AF37]","active-variant"),m.classList.add("border-white/10","text-white/60"))}),a.classList.contains("rounded-full")?(a.classList.remove("border-white/20"),a.classList.add("border-[#D4AF37]","scale-110","active-variant")):(a.classList.remove("border-white/10","text-white/60"),a.classList.add("bg-[#D4AF37]","text-black","border-[#D4AF37]","active-variant"))})});const P=document.querySelectorAll(".option-btn"),T=()=>{const e=[];i.config.options.forEach((o,d)=>{e.push(r.compositeSelection[d]||0)});let t=null;i.config.combinations&&(t=i.config.combinations.find(o=>JSON.stringify(o.indices)===JSON.stringify(e)));let n=t?t.price:i.pricing?.basePrice||0,s=[],a="";i.config.options.forEach((o,d)=>{const f=r.compositeSelection[d]||0,c=o.values[f];s.push(c.name),c.image&&(a=c.image)}),r.currentPrice=n,r.selectedVariantName=s.join(" + "),t&&t.sku,a&&a!==r.currentImage&&h(a),u&&(u.innerText=n.toLocaleString(),u.classList.add("scale-110","text-[#D4AF37]"),setTimeout(()=>u.classList.remove("scale-110","text-[#D4AF37]"),150))};i.config?.variantType==="composite"&&T(),P.forEach(e=>{const t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e),t.addEventListener("click",n=>{const s=n.currentTarget,a=parseInt(s.dataset.groupIndex||"0"),o=parseInt(s.dataset.valueIndex||"0");r.compositeSelection[a]=o;const d=document.querySelector(`.option-group[data-group-index="${a}"]`);d&&d.querySelectorAll(".option-btn").forEach(f=>{f.classList.remove("bg-[#D4AF37]","text-black","border-[#D4AF37]","active-option"),f.classList.add("border-white/10","text-white/60")}),s.classList.remove("border-white/10","text-white/60"),s.classList.add("bg-[#D4AF37]","text-black","border-[#D4AF37]","active-option"),T()})}),F?.addEventListener("click",()=>{if(p){let e=parseInt(p.value);e>1&&(p.value=(e-1).toString())}}),_?.addEventListener("click",()=>{if(p){let e=parseInt(p.value);p.value=(e+1).toString()}}),g?.addEventListener("click",()=>{if(!g)return;const e=parseInt(p?.value||"1"),t=r.selectedVariantName.replace(/\s+/g,"-").toLowerCase(),s={id:`${i.id}-${t}`,product_id:i.id,title:`${i.meta.title} (${r.selectedVariantName})`,price:r.currentPrice,image:r.currentImage,variant_name:r.selectedVariantName};for(let o=0;o<e;o++)V.add(s);const a=g.innerHTML;g.innerHTML='<span class="flex items-center gap-2">Added!</span>',g.classList.add("bg-white","text-black"),setTimeout(()=>{g.innerHTML=a,g.classList.remove("bg-white","text-black")},1e3)}),document.getElementById("chat-seller-btn")?.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget,n=t.dataset.shopId,s=t.dataset.productTitle,{data:{session:a}}=await b.auth.getSession();if(!a){window.location.href="/login?redirect="+window.location.pathname;return}t.innerText="Starting...";const{data:o}=await b.from("shops").select("owner_id").eq("id",n).single();if(!o){alert("Shop not found");return}if(o.owner_id===a.user.id){alert("You cannot chat with yourself!"),t.innerHTML="Chat";return}const{data:d}=await b.from("conversation_participants").select("conversation_id, conversation:conversations!inner(id, metadata)").eq("user_id",a.user.id);let c=d?.find(L=>L.conversation?.metadata?.shop_id===n)?.conversation_id;if(!c){const{data:L,error:m}=await b.from("conversations").insert({type:"p2p",title:`Chat about ${s}`,metadata:{shop_id:n}}).select().single();if(m){console.error(m),alert("Error starting chat");return}c=L.id,await b.from("conversation_participants").insert([{conversation_id:c,user_id:a.user.id},{conversation_id:c,user_id:o.owner_id}])}window.location.href=`/chat?id=${c}`})}document.addEventListener("astro:page-load",D);D();
