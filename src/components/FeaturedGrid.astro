---
// src/components/FeaturedGrid.astro
import { supabase } from "../lib/supabase";

const ORDER = [
    "cryptoclock-basic",
    "bitterm-series",
    "bitnode-personal",
    "bitcoin-t-shirt--by-blc",
];

const { data: dbProducts } = await supabase
    .from("products")
    .select("*")
    .in("id", ORDER);

// Sort by defined order
const sortedProducts = dbProducts?.sort((a, b) => {
    return ORDER.indexOf(a.id) - ORDER.indexOf(b.id);
});

const items = (sortedProducts || []).map((p) => {
    let price = 0;
    let comparePrice = 0;
    const hasVariants = p.config?.variants && p.config.variants.length > 0;

    if (hasVariants) {
        // Source pricing ONLY from variants
        p.config.variants.forEach((v: any) => {
            const vPrice =
                typeof v.price === "string" ? parseFloat(v.price) : v.price;
            const vCompare = v.comparePrice
                ? typeof v.comparePrice === "string"
                    ? parseFloat(v.comparePrice)
                    : v.comparePrice
                : 0;

            if (vPrice > 0 && (price === 0 || vPrice < price)) {
                price = vPrice;
            }
            if (vCompare > 0 && vCompare > comparePrice) {
                comparePrice = vCompare;
            }
        });
    } else {
        // Fallback to base pricing
        price = p.pricing?.basePrice || 0;
        comparePrice = p.pricing?.comparePrice || 0;
    }

    const hasDiscount = comparePrice > price && comparePrice > 0;
    const discount = hasDiscount
        ? Math.round(((comparePrice - price) / comparePrice) * 100)
        : 0;

    return {
        id: p.id,
        title: p.meta?.title || p.name || "Untitled Product",
        price: price,
        originalPrice: hasDiscount ? comparePrice : null,
        discount: discount,
        image: p.media?.mainImage || "/images/placeholder.webp",
        // Add second image for hover effect
        hoverImage: p.media?.gallery?.[1] || null,
        category: p.category || "General",
        tag: p.tags?.[0] || (discount > 0 ? "SALE" : null),
        slug: p.id, // Using ID as slug for reliable linking to [id].astro
    };
});
---

<section class="max-w-[1800px] mx-auto px-6 md:px-12 py-32 relative">
    <div
        class="flex flex-col md:flex-row justify-between items-end mb-20 gap-8 reveal"
    >
        <div class="space-y-4">
            <h2
                class="text-5xl md:text-7xl font-[900] tracking-tighter leading-none italic uppercase text-white"
            >
                Curated <br />
                <span class="text-white/10 not-italic">Selection.</span>
            </h2>
            <div
                class="w-24 h-1 bg-gradient-to-r from-[#D4AF37] to-transparent"
            >
            </div>
        </div>
        <a
            href="/shop"
            class="group flex items-center gap-4 text-[#D4AF37] eng font-black uppercase tracking-[0.3em] text-xs pb-2 border-b border-[#D4AF37]/20 hover:border-[#D4AF37] transition-all"
        >
            Explore All
            <svg
                class="group-hover:translate-x-2 transition-transform"
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><path d="M5 12h14m-7-7 7 7-7 7"></path></svg
            >
        </a>
    </div>

    <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-8 gap-y-16"
    >
        {
            items.map((item, i) => (
                <div
                    class="group relative reveal"
                    style={`animation-delay: ${0.2 * i}s`}
                >
                    <a
                        href={`/products/${item.slug || item.id}`}
                        class="group relative block space-y-6 isolate cursor-pointer"
                    >
                        <div class="aspect-square bg-[#0a0a0a] rounded-[2rem] overflow-hidden border border-white/5 group-hover:border-[#D4AF37]/30 transition-all relative">
                            {/* Main Image */}
                            <img
                                src={item.image}
                                alt={item.title}
                                class={`absolute inset-0 w-full h-full object-cover transition-all duration-700 ease-[cubic-bezier(0.34,1.56,0.64,1)] group-hover:scale-110 ${item.hoverImage ? "group-hover:opacity-0" : ""}`}
                            />

                            {/* Hover Image (Second Image) */}
                            {item.hoverImage && (
                                <img
                                    src={item.hoverImage}
                                    alt={item.title}
                                    class="absolute inset-0 w-full h-full object-cover opacity-0 group-hover:opacity-100 transition-all duration-700 ease-[cubic-bezier(0.34,1.56,0.64,1)] group-hover:scale-110"
                                />
                            )}

                            {/* Sale Ribbon */}
                            {item.discount > 0 && (
                                <div class="absolute top-0 right-0 w-32 h-32 overflow-hidden pointer-events-none z-30">
                                    <div class="absolute top-6 -right-10 w-40 bg-gradient-to-r from-[#ff0000] to-[#cc0000] text-white text-[10px] font-black tracking-widest uppercase py-1.5 text-center rotate-45 shadow-lg border-y border-white/20">
                                        SALE -{item.discount}%
                                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full animate-[shimmer-simple_3s_infinite]" />
                                    </div>
                                </div>
                            )}

                            {!item.discount && item.tag && (
                                <div class="absolute top-4 left-4 bg-black/80 backdrop-blur-md border border-white/10 px-3 py-1.5 rounded-lg pointer-events-none">
                                    <span class="text-[10px] font-black tracking-[0.2em] text-[#D4AF37] uppercase">
                                        {item.tag}
                                    </span>
                                </div>
                            )}

                            {/* Overlay Button */}
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                                <div class="bg-[#D4AF37] text-black px-6 py-3 rounded-xl font-black text-xs tracking-widest uppercase transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 shadow-[0_4px_20px_rgba(212,175,55,0.4)]">
                                    View Details
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-black tracking-[0.2em] text-[#D4AF37] uppercase">
                                    {item.category}
                                </span>
                            </div>
                            <h3 class="text-lg font-bold leading-tight group-hover:text-[#D4AF37] transition-colors">
                                {item.title}
                            </h3>
                            <div class="flex items-baseline gap-3">
                                <span class="text-xl font-black text-white font-mono">
                                    {item.price.toLocaleString()}
                                    <span class="text-xs ml-1 text-white/50 font-sans font-bold">
                                        THB
                                    </span>
                                </span>
                                {item.originalPrice &&
                                    item.originalPrice > item.price && (
                                        <span class="text-sm text-white/30 line-through font-mono">
                                            {item.originalPrice.toLocaleString()}
                                        </span>
                                    )}
                            </div>
                        </div>
                    </a>
                </div>
            ))
        }
    </div>
</section>

<style>
    .reveal {
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 1s cubic-bezier(0.19, 1, 0.22, 1) forwards;
    }
    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    @keyframes shimmer-simple {
        to {
            transform: translateX(200%);
        }
    }
</style>
