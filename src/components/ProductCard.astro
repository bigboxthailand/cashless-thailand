---
export interface Props {
  id: string;
  title: string;
  price: number;
  originalPrice?: number;
  image: string;
  hoverImage?: string; // รูปตอนเอาเมาส์ชี้ (ถ้ามี)
  category: string;
  tag?: string;
  status?: string; // 'In Stock', 'Sold Out'
  sellerDistrict?: string; // อำเภอผู้ส่ง
  sellerProvince?: string; // จังหวัดผู้ส่ง
}

const {
  id,
  title,
  price,
  originalPrice,
  image,
  hoverImage,
  category,
  tag,
  status = "In Stock",
  sellerDistrict,
  sellerProvince,
} = Astro.props;

const formattedPrice = price.toLocaleString();
const discountPercentage = originalPrice
  ? Math.round(((originalPrice - price) / originalPrice) * 100)
  : 0;

// Format seller location
const sellerLocation = sellerProvince
  ? sellerDistrict
    ? `${sellerDistrict}, ${sellerProvince}`
    : sellerProvince
  : null;
---

<a
  href={`/products/${id}`}
  class="group relative block product-card"
  data-category={category}
  data-price={price}
  data-title={title.toLowerCase()}
>
  <div
    class="aspect-[4/5] bg-[#111] rounded-[1.5rem] overflow-hidden border border-white/5 group-hover:border-[#D4AF37]/50 transition-all duration-500 relative mb-4"
  >
    <!-- Discount Badge -->
    {
      originalPrice && originalPrice > price && (
        <div class="absolute top-3 right-3 z-20 px-2 py-1 bg-red-600 text-white text-[10px] font-black uppercase tracking-wider rounded-md shadow-lg shadow-red-900/40 animate-pulse">
          -{discountPercentage}%
        </div>
      )
    }

    {
      tag && (
        <div class="absolute top-3 left-3 z-20 px-3 py-1 bg-[#D4AF37] text-black text-[9px] font-black uppercase tracking-widest rounded-md">
          {tag}
        </div>
      )
    }

    <img
      src={image}
      alt={title}
      class={`absolute inset-0 w-full h-full object-cover transition-opacity duration-500 ${hoverImage ? "group-hover:opacity-0" : ""}`}
      loading="lazy"
    />

    {
      hoverImage && (
        <img
          src={hoverImage}
          alt={title}
          class="absolute inset-0 w-full h-full object-cover opacity-0 group-hover:opacity-100 transition-opacity duration-500"
          loading="lazy"
        />
      )
    }

    <div
      class="absolute inset-x-0 bottom-0 p-4 translate-y-full group-hover:translate-y-0 transition-transform duration-300 z-30"
    >
      <button
        class="w-full bg-white text-black py-3 rounded-xl font-bold uppercase text-xs tracking-wider hover:bg-[#D4AF37] transition-colors shadow-lg"
      >
        {status === "Sold Out" ? "Out of Stock" : "Quick Add"}
      </button>
    </div>

    <div
      class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors pointer-events-none z-10"
    >
    </div>
  </div>

  <div class="space-y-1 px-1">
    <div class="flex justify-between items-start">
      <h3
        class="text-white text-base font-bold leading-tight group-hover:text-[#D4AF37] transition-colors line-clamp-2 min-h-[2.5em]"
      >
        {title}
      </h3>
    </div>
    <div class="flex flex-col">
      <div class="flex items-center gap-2">
        {
          originalPrice && originalPrice > price && (
            <span class="text-white/30 line-through text-sm font-medium">
              {originalPrice.toLocaleString()} ฿
            </span>
          )
        }
        <span
          class={`font-bold eng text-lg ${originalPrice && originalPrice > price ? "text-red-500" : "text-white/90"}`}
        >
          {formattedPrice} THB
        </span>
      </div>
      <span
        class="sats-display text-[#F7931A] text-[10px] eng font-medium"
        data-thb={price}>≈ ... Sats</span
      >
      {
        sellerLocation && (
          <div class="flex items-center gap-1 mt-1">
            <svg
              class="w-3 h-3 text-white/40"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            <span class="text-white/40 text-[10px]">
              ส่งจาก: {sellerLocation}
            </span>
          </div>
        )
      }
    </div>
  </div>
</a>

<script>
  // Client-side sats calculation using CoinGecko API
  let btcPriceCache: number | null = null;
  let lastFetchTime = 0;
  const CACHE_DURATION = 60000;

  async function fetchBtcPrice(): Promise<number> {
    const now = Date.now();
    if (btcPriceCache && now - lastFetchTime < CACHE_DURATION) {
      return btcPriceCache as number;
    }

    try {
      const response = await fetch(
        "https://api.bitkub.com/api/v3/market/ticker?sym=BTC_THB",
      );
      const data = await response.json();
      // Bitkub v3 returns array: [{ symbol: 'BTC_THB', last: '...' }]
      let price = 0;
      if (Array.isArray(data) && data[0]?.last) {
        price = parseFloat(data[0].last);
      }

      if (price) {
        btcPriceCache = price;
        lastFetchTime = now;
        return price;
      }
      throw new Error("Invalid Bitkub v3 data");
    } catch (error) {
      return btcPriceCache || 3300000;
    }
  }

  async function updateAllSatsDisplays() {
    const btcPrice = await fetchBtcPrice();
    document.querySelectorAll(".sats-display").forEach((el) => {
      const thb = parseFloat((el as HTMLElement).dataset.thb || "0");
      const sats = Math.ceil((thb / btcPrice) * 100000000);
      el.textContent = `≈ ${sats.toLocaleString()} Sats`;
    });
  }

  document.addEventListener("astro:page-load", updateAllSatsDisplays);
  document.addEventListener("DOMContentLoaded", updateAllSatsDisplays);
</script>
