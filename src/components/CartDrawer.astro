---
// src/components/CartDrawer.astro
---

<div id="cart-drawer" class="fixed inset-0 z-[200] pointer-events-none invisible transition-all duration-300">
    <div id="cart-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
    
    <div id="cart-panel" class="absolute top-0 right-0 h-full w-full max-w-md bg-[#0a0a0a] border-l border-[#D4AF37]/20 transform translate-x-full transition-transform duration-300 flex flex-col pointer-events-auto z-10">
        
        <div class="p-6 border-b border-white/10 flex items-center justify-between bg-black/50 backdrop-blur-md">
            <h2 class="text-xl font-black text-white uppercase tracking-wider flex items-center gap-2">
                Your Cart
                <span id="cart-total-count" class="text-xs bg-[#D4AF37] text-black px-2 py-0.5 rounded-full">0</span>
            </h2>
            <button id="close-cart-btn" class="text-white/50 hover:text-red-500 transition-colors cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-hide" id="cart-items-container">
            </div>

        <div id="cart-empty-state" class="hidden flex-1 flex flex-col items-center justify-center text-white/30 p-8">
            <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
            <p class="eng text-sm uppercase tracking-widest font-bold">Your cart is empty</p>
        </div>

        <div class="p-6 border-t border-white/10 bg-black/50 backdrop-blur-md space-y-4">
            <div class="flex justify-between items-end">
                <span class="text-white/50 text-sm font-medium uppercase tracking-widest">Total</span>
                <div class="text-right">
                    <div id="cart-total-price" class="text-2xl font-black text-[#D4AF37] eng">0 THB</div>
                    <div id="cart-total-sats" class="text-xs text-white/40 eng">≈ 0 Sats</div>
                </div>
            </div>
            
            <a href="/checkout" class="block w-full bg-[#D4AF37] text-black font-black uppercase tracking-widest py-4 rounded-xl text-center hover:bg-[#b8962e] transition-all shadow-[0_0_20px_rgba(212,175,55,0.2)] hover:shadow-[0_0_30px_rgba(212,175,55,0.4)]">
                Checkout Now
            </a>
        </div>
    </div>
</div>

<script>
    import { cartStore } from '../scripts/cartStore.js';

    document.addEventListener('astro:page-load', () => {
        const drawer = document.getElementById('cart-drawer');
        const panel = document.getElementById('cart-panel');
        const backdrop = document.getElementById('cart-backdrop');
        const closeBtn = document.getElementById('close-cart-btn');
        const itemsContainer = document.getElementById('cart-items-container');
        const emptyState = document.getElementById('cart-empty-state');
        const totalEl = document.getElementById('cart-total-price');
        const satsEl = document.getElementById('cart-total-sats');
        const countEl = document.getElementById('cart-total-count');

        if (!drawer || !panel || !backdrop) return;

        // ฟังก์ชันเปิด/ปิด UI (ใช้ Class Toggle เพื่อความชัวร์ 100%)
        const toggleDrawer = (open) => {
            if (open) {
                // 1. เปิด Container หลัก
                drawer.classList.remove('invisible', 'pointer-events-none');
                
                // 2. แสดงฉากหลัง (Fade In)
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    // 3. เลื่อนตะกร้าออกมา (Slide In)
                    panel.classList.remove('translate-x-full'); 
                }, 10); // หน่วงนิดนึงเพื่อให้ Transition ทำงานสวยๆ

                renderCart();
            } else {
                // 1. เลื่อนตะกร้าเก็บ (Slide Out)
                panel.classList.add('translate-x-full');
                // 2. ซ่อนฉากหลัง (Fade Out)
                backdrop.classList.add('opacity-0');
                
                // 3. รอให้ Animation จบแล้วค่อยซ่อน Container
                setTimeout(() => {
                    drawer.classList.add('invisible', 'pointer-events-none');
                }, 300);
            }
        };

        const renderCart = () => {
            try {
                const cart = cartStore.get();
                const { total, sats, count } = cartStore.totals();

                if(totalEl) totalEl.innerText = total.toLocaleString() + ' THB';
                if(satsEl) satsEl.innerText = '≈ ' + sats.toLocaleString() + ' Sats';
                if(countEl) countEl.innerText = count.toString();

                if (cart.length === 0) {
                    if(itemsContainer) itemsContainer.innerHTML = '';
                    emptyState?.classList.remove('hidden');
                } else {
                    emptyState?.classList.add('hidden');
                    if(itemsContainer) {
                        itemsContainer.innerHTML = cart.map(item => `
                            <div class="flex gap-4 items-center bg-white/5 p-3 rounded-xl border border-white/5 relative group mb-3">
                                <div class="w-16 h-16 bg-black rounded-lg overflow-hidden shrink-0">
                                    <img src="${item.image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100x100?text=No+Image'"/>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="eng text-sm font-bold text-white truncate pr-6">${item.title}</h3>
                                    <div class="flex items-center justify-between mt-2">
                                        <p class="eng text-[#D4AF37] text-xs font-bold">${Number(item.price).toLocaleString()} ฿</p>
                                        <div class="flex items-center gap-2 bg-black/40 rounded-lg p-1">
                                            <button class="qty-btn w-6 h-6 flex items-center justify-center text-white/50 hover:text-white transition-colors" data-action="minus" data-id="${item.id}">-</button>
                                            <span class="text-xs font-bold text-white w-4 text-center">${item.quantity}</span>
                                            <button class="qty-btn w-6 h-6 flex items-center justify-center text-white/50 hover:text-white transition-colors" data-action="plus" data-id="${item.id}">+</button>
                                        </div>
                                    </div>
                                </div>
                                <button class="remove-btn absolute top-2 right-2 text-white/20 hover:text-red-400 transition-colors p-1" data-id="${item.id}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                        `).join('');
                        attachItemListeners();
                    }
                }
            } catch (err) {
                console.error("Render Cart Error:", err);
            }
        };

        const attachItemListeners = () => {
            if(!itemsContainer) return;
            
            itemsContainer.querySelectorAll('.qty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // @ts-ignore
                    const id = e.currentTarget.dataset.id;
                    // @ts-ignore
                    const action = e.currentTarget.dataset.action;
                    if(id) cartStore.updateQty(id, action === 'plus' ? 1 : -1);
                    // ไม่ต้องเรียก renderCart() ตรงนี้ เพราะเดี๋ยว Store จะ dispatch event กลับมาเอง
                });
            });

            itemsContainer.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // @ts-ignore
                    const id = e.currentTarget.dataset.id;
                    if(id) cartStore.remove(id);
                });
            });
        };

        // --- Event Listeners ---
        window.addEventListener('toggle-cart', (e) => {
            // @ts-ignore
            toggleDrawer(e.detail.open);
        });

        window.addEventListener('cart-updated', () => {
            renderCart();
        });

        closeBtn?.addEventListener('click', () => toggleDrawer(false));
        backdrop?.addEventListener('click', () => toggleDrawer(false));
    });
</script>