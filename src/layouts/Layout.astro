---
// src/layouts/Layout.astro
import { ViewTransitions } from "astro:transitions";
import "../styles/global.css";
import "../styles/cart-fix.css";
import CartDrawer from "../components/CartDrawer.astro";
import ChatWidget from "../components/chat/ChatWidget.jsx";

interface Props {
    title: string;
    description?: string;
}

const {
    title,
    description = "Cashless Thailand - The Future of Digital Finance",
} = Astro.props;
---

<!doctype html>
<html lang="th" class="bg-[#050505] scroll-smooth">
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content={description} />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/images/ui/favicon.svg" />
        <title>{title}</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Anuphan:wght@100;300;400;500;600;700&family=Inter:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,900&display=swap"
            rel="stylesheet"
        />

        <ViewTransitions />
    </head>
    <body
        class="text-white/90 antialiased selection:bg-[#D4AF37] selection:text-black cursor-none overflow-x-hidden"
    >
        <div
            class="fixed inset-0 z-[9999] pointer-events-none opacity-[0.04] bg-[url('https://grainy-gradients.vercel.app/noise.svg')] mix-blend-overlay"
        >
        </div>

        <div
            id="cursor"
            class="fixed w-8 h-8 border border-[#D4AF37] rounded-full pointer-events-none z-[10000] transition-transform duration-75 ease-out scale-0 md:block hidden mix-blend-difference"
        >
        </div>
        <div
            id="cursor-dot"
            class="fixed w-1.5 h-1.5 bg-[#D4AF37] rounded-full pointer-events-none z-[10000] md:block hidden mix-blend-difference"
        >
        </div>

        <div class="relative z-10 flex flex-col min-h-screen">
            <slot />
        </div>

        <script>
            import { cartStore } from "../lib/cartStore.js";

            document.addEventListener("astro:page-load", () => {
                // 1. CUSTOM CURSOR LOGIC
                const cursor = document.getElementById("cursor");
                const dot = document.getElementById("cursor-dot");
                let mouseX = 0,
                    mouseY = 0,
                    cursorX = 0,
                    cursorY = 0;

                document.addEventListener("mousemove", (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                    if (dot) {
                        dot.style.transform = `translate(${mouseX}px, ${mouseY}px)`;
                    }
                    cursor?.classList.remove("scale-0");
                });

                const animateCursor = () => {
                    cursorX += (mouseX - cursorX) * 0.15;
                    cursorY += (mouseY - cursorY) * 0.15;
                    if (cursor) {
                        cursor.style.transform = `translate(${cursorX - 16}px, ${cursorY - 16}px)`;
                    }
                    requestAnimationFrame(animateCursor);
                };
                animateCursor();

                // 2. MAGNETIC BUTTONS
                const magneticButtons = document.querySelectorAll(
                    "button, .magnet-link, a.button",
                );
                magneticButtons.forEach((btn) => {
                    btn.addEventListener("mousemove", (e: any) => {
                        const rect = (
                            btn as HTMLElement
                        ).getBoundingClientRect();
                        const x = e.clientX - rect.left - rect.width / 2;
                        const y = e.clientY - rect.top - rect.height / 2;
                        (btn as HTMLElement).style.transform =
                            `translate(${x / 5}px, ${y / 5}px)`;
                        cursor?.classList.add(
                            "scale-[2.5]",
                            "bg-[#D4AF37]/10",
                            "border-transparent",
                        );
                    });

                    btn.addEventListener("mouseleave", () => {
                        (btn as HTMLElement).style.transform =
                            `translate(0px, 0px)`;
                        cursor?.classList.remove(
                            "scale-[2.5]",
                            "bg-[#D4AF37]/10",
                            "border-transparent",
                        );
                    });
                });

                // 3. CART LOGIC (à¹ƒà¸ªà¹ˆ Try-Catch à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¹€à¸§à¹‡à¸šà¸žà¸±à¸‡)
                const updateBadge = () => {
                    try {
                        const totals = cartStore.totals();
                        // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ count à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ 0 à¹à¸—à¸™ (à¸à¸±à¸™ Error)
                        const count = totals.count || 0;

                        const badges = document.querySelectorAll(
                            ".cart-count, #cart-trigger span",
                        );
                        badges.forEach((el) => {
                            el.textContent = count.toString();
                            el.classList.toggle("hidden", count === 0);
                            el.classList.add("scale-125");
                            setTimeout(
                                () => el.classList.remove("scale-125"),
                                200,
                            );
                        });
                    } catch (err) {
                        console.warn("Cart Badge Update Failed:", err);
                    }
                };

                updateBadge();

                // === CART BUTTON FIX ===
                const cartBtn = document.getElementById("cart-trigger");
                if (cartBtn) {
                    cartBtn.style.pointerEvents = "auto";
                    cartBtn.style.zIndex = "999999";
                    cartBtn.style.position = "relative";
                    cartBtn.style.cursor = "pointer";

                    // Note: We use the existing button if possible or just attach listener
                    // Cloning invalidates references held by others, so we should be careful.
                    // But if it's a fix for lost listeners, replacement is the way.

                    const newBtn = cartBtn.cloneNode(true);
                    cartBtn.parentNode?.replaceChild(newBtn, cartBtn);

                    newBtn.addEventListener(
                        "click",
                        (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log("ðŸ›’ Cart clicked!");
                            cartStore.open();
                        },
                        { capture: true },
                    );

                    console.log("âœ… Cart button fixed");
                }
                window.addEventListener("cart-updated", updateBadge);

                // 4. TEXT REVEAL
                const splitElements = document.querySelectorAll(".split-text");
                const observer = new IntersectionObserver(
                    (entries) => {
                        entries.forEach((entry) => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add("is-visible");
                            }
                        });
                    },
                    { threshold: 0.1 },
                );
                splitElements.forEach((el) => observer.observe(el));
            });
        </script>
        <script>
            import { cartStore } from "../lib/cartStore.js";
            // ... (rest of script)
        </script>
        <ChatWidget client:load />
        <CartDrawer />
    </body>
</html>

<style is:global>
    :root {
        --gold-primary: #d4af37;
        --gold-secondary: #f9e79f;
        --black-bg: #050505;
    }

    body {
        font-family: "Anuphan", sans-serif;
        background-color: var(--black-bg);
    }
    .eng {
        font-family: "Inter", sans-serif;
    }

    /* Global Transition */
    button,
    a {
        transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* TEXT REVEAL ANIMATION */
    .split-text span {
        display: inline-block;
        opacity: 0;
        transform: translateY(100%);
        transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .split-text.is-visible span {
        opacity: 1;
        transform: translateY(0);
    }
    .split-text.is-visible span:nth-child(1) {
        transition-delay: 0.1s;
    }
    .split-text.is-visible span:nth-child(2) {
        transition-delay: 0.2s;
    }
    .split-text.is-visible span:nth-child(3) {
        transition-delay: 0.3s;
    }

    /* Scrollbar */
    html::-webkit-scrollbar {
        width: 6px;
    }
    html::-webkit-scrollbar-track {
        background: #050505;
    }
    html::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
    }
    html::-webkit-scrollbar-thumb:hover {
        background: #d4af37;
    }

    /* Utility Class for Gold Text Gradient */
    .text-gold {
        background: linear-gradient(to bottom right, #f9e79f, #d4af37, #996515);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Utility for Glass Effect */
    .glass-gold {
        background: rgba(212, 175, 55, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(212, 175, 55, 0.1);
    }
</style>
