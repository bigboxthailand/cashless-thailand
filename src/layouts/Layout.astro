---
// src/layouts/Layout.astro
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';

interface Props {
	title: string;
	description?: string;
}

const { 
	title, 
	description = "Cashless Thailand - The Future of Digital Finance" 
} = Astro.props;
---

<!doctype html>
<html lang="th" class="bg-[#050505] scroll-smooth">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={description} />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<title>{title}</title>
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@100;300;400;500;600;700&family=Inter:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,900&display=swap" rel="stylesheet">
		
		<ViewTransitions />
	</head>
	<body class="text-white/90 antialiased selection:bg-[#D4AF37] selection:text-black cursor-none overflow-x-hidden">
		
		<div class="fixed inset-0 z-[9999] pointer-events-none opacity-[0.04] bg-[url('https://grainy-gradients.vercel.app/noise.svg')] mix-blend-overlay"></div>

		<div id="cursor" class="fixed w-8 h-8 border border-[#D4AF37] rounded-full pointer-events-none z-[10000] transition-transform duration-75 ease-out scale-0 md:block hidden mix-blend-difference"></div>
		<div id="cursor-dot" class="fixed w-1.5 h-1.5 bg-[#D4AF37] rounded-full pointer-events-none z-[10000] md:block hidden mix-blend-difference"></div>

		<div class="relative z-10 flex flex-col min-h-screen">
			<slot />
		</div>

		<script>
            // Import สมองของตะกร้าสินค้า
            import { cartStore } from '../scripts/cartStore.js';

			document.addEventListener('astro:page-load', () => {
				
                // -------------------------------------------------------
                // 1. CUSTOM CURSOR LOGIC (เมาส์วงแหวน)
                // -------------------------------------------------------
				const cursor = document.getElementById('cursor');
				const dot = document.getElementById('cursor-dot');
				let mouseX = 0, mouseY = 0, cursorX = 0, cursorY = 0;

				document.addEventListener('mousemove', (e) => {
					mouseX = e.clientX;
					mouseY = e.clientY;
                    if(dot) { dot.style.transform = `translate(${mouseX}px, ${mouseY}px)`; }
					cursor?.classList.remove('scale-0');
				});

                // Smooth Lerp Animation
				const animateCursor = () => {
					cursorX += (mouseX - cursorX) * 0.15;
					cursorY += (mouseY - cursorY) * 0.15;
					if (cursor) {
						cursor.style.transform = `translate(${cursorX - 16}px, ${cursorY - 16}px)`;
					}
					requestAnimationFrame(animateCursor);
				};
				animateCursor();

                // -------------------------------------------------------
                // 2. MAGNETIC BUTTONS (ปุ่มดูดเมาส์)
                // -------------------------------------------------------
                const magneticButtons = document.querySelectorAll('button, .magnet-link, a.button');
                magneticButtons.forEach((btn) => {
                    btn.addEventListener('mousemove', (e: any) => {
                        const rect = (btn as HTMLElement).getBoundingClientRect();
                        const x = e.clientX - rect.left - rect.width / 2;
                        const y = e.clientY - rect.top - rect.height / 2;
                        
                        // แรงดึงดูด (ปรับเลข 5 = หนืดมาก, 10 = หนืดน้อย)
                        (btn as HTMLElement).style.transform = `translate(${x/5}px, ${y/5}px)`;
                        cursor?.classList.add('scale-[2.5]', 'bg-[#D4AF37]/10', 'border-transparent');
                    });

                    btn.addEventListener('mouseleave', () => {
                        (btn as HTMLElement).style.transform = `translate(0px, 0px)`;
                        cursor?.classList.remove('scale-[2.5]', 'bg-[#D4AF37]/10', 'border-transparent');
                    });
                });

                // -------------------------------------------------------
                // 3. CART LOGIC (ระบบตะกร้าสินค้า)
                // -------------------------------------------------------
                
                // อัปเดตตัวเลขบน Badge เมื่อโหลดหน้า
                const updateBadge = () => {
                    const { count } = cartStore.totals();
                    const badges = document.querySelectorAll('.cart-count, #cart-trigger span');
                    badges.forEach(el => {
                        el.textContent = count.toString();
                        el.classList.toggle('hidden', count === 0);
                        // Animation เด้งดึ๋งเมื่อเลขเปลี่ยน
                        el.classList.add('scale-125');
                        setTimeout(() => el.classList.remove('scale-125'), 200);
                    });
                };
                updateBadge(); // เรียกทันที 1 ครั้ง
                window.addEventListener('cart-updated', updateBadge); // รอฟัง event จาก cartStore

                // ดักจับการกดปุ่ม "Add to Cart" ทั่วเว็บ (ไม่ต้องเขียน JS แยกแต่ละหน้า)
                document.body.addEventListener('click', (e) => {
                    const target = e.target as HTMLElement;
                    // หาปุ่มที่มีคำว่า Add to Cart หรืออยู่ใน class product-card
                    const btn = target.closest('button'); 
                    
                    if (btn && btn.innerText.toLowerCase().includes('add to cart')) {
                        e.preventDefault();
                        e.stopPropagation();

                        // พยายามดึงข้อมูลสินค้าจาก HTML
                        // 1. จากหน้า Product Detail (Main)
                        const mainTitle = document.querySelector('h1')?.innerText;
                        const mainPriceStr = document.querySelector('.price__regular, .text-3xl.text-\\[\\#D4AF37\\]')?.innerText;
                        
                        // 2. จาก Product Card (Grid)
                        const card = btn.closest('.product-card, .product-item');
                        
                        let product = { id: '', title: '', price: 0, image: '' };

                        if (card) {
                            // กรณีคลิกจากหน้า Grid
                            product.id = card.getAttribute('href')?.split('/').pop() || '';
                            product.title = card.querySelector('h3')?.innerText || '';
                            const priceText = card.querySelector('span.eng')?.innerText || '0';
                            product.price = parseFloat(priceText.replace(/[^0-9.]/g, ''));
                            product.image = card.querySelector('img')?.src || '';
                        } else {
                            // กรณีคลิกจากหน้า Detail
                            product.id = window.location.pathname.split('/').pop() || '';
                            product.title = mainTitle || '';
                            product.price = parseFloat(mainPriceStr?.replace(/[^0-9.]/g, '') || '0');
                            product.image = (document.getElementById('main-image') as HTMLImageElement)?.src || '';
                        }

                        if (product.id && product.title) {
                            cartStore.add(product); // ส่งเข้า Store
                            
                            // Effect ปุ่มยุบตัว
                            btn.classList.add('scale-95');
                            setTimeout(() => btn.classList.remove('scale-95'), 150);
                            
                            // เปิดตะกร้าโชว์
                            document.dispatchEvent(new CustomEvent('toggle-cart', { detail: { open: true } }));
                        }
                    }
                });

                // -------------------------------------------------------
                // 4. TEXT REVEAL (ตัวหนังสือไหลขึ้น)
                // -------------------------------------------------------
                const splitElements = document.querySelectorAll('.split-text');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                        }
                    });
                }, { threshold: 0.1 });

                splitElements.forEach(el => observer.observe(el));

			});
		</script>
	</body>
</html>

<style is:global>
	:root {
		--gold-primary: #D4AF37;
		--gold-secondary: #F9E79F;
		--black-bg: #050505;
	}

	body { font-family: 'Anuphan', sans-serif; background-color: var(--black-bg); }
	.eng { font-family: 'Inter', sans-serif; }
    
    /* Global Transition */
    button, a { transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

    /* TEXT REVEAL ANIMATION */
    .split-text span {
        display: inline-block;
        opacity: 0;
        transform: translateY(100%);
        transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .split-text.is-visible span {
        opacity: 1;
        transform: translateY(0);
    }
    .split-text.is-visible span:nth-child(1) { transition-delay: 0.1s; }
    .split-text.is-visible span:nth-child(2) { transition-delay: 0.2s; }
    .split-text.is-visible span:nth-child(3) { transition-delay: 0.3s; }
    
    /* Scrollbar */
	html::-webkit-scrollbar { width: 6px; }
	html::-webkit-scrollbar-track { background: #050505; }
	html::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
	html::-webkit-scrollbar-thumb:hover { background: #D4AF37; }

    /* Utility Class for Gold Text Gradient */
    .text-gold {
		background: linear-gradient(to bottom right, #F9E79F, #D4AF37, #996515);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
	}
    
    /* Utility for Glass Effect */
    .glass-gold {
		background: rgba(212, 175, 55, 0.05);
		backdrop-filter: blur(10px);
		border: 1px solid rgba(212, 175, 55, 0.1);
	}
</style>