---
// src/pages/products/[id].astro
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import CartDrawer from '../../components/CartDrawer.astro';

export async function getStaticPaths() {
  const products = [
    // --- 1. CryptoClock Basic (แก้ตัวเลือกที่ 3 เป็นสีใส) ---
    {
      id: 'cryptoclock-basic',
      title: "CryptoClock Basic",
      price: 1500,
      description: "นาฬิกาคริปโตดูราคารุ่นเริ่มต้น ขนาดกะทัดรัด เชื่อมต่อ WiFi แสดงราคา Bitcoin และ Altcoins ได้แบบ Real-time",
      specs: ["WiFi Connected", "LED Matrix Display", "USB-C Power"],
      images: ["/images/Basic_White_Center.webp"],
      variantType: "color",
      variants: [
        { name: 'White', color: '#F0F0F0', image: '/images/Basic_White_Center.webp', price: 1500 },
        { name: 'Black', color: '#111111', image: '/images/Basic_Black_Center.webp', price: 1500 },
        // [แก้ตรงนี้] เปลี่ยนจาก Orange เป็น Transparent (สีใส)
        { name: 'Transparent', color: '#E5E5E5', image: '/images/Basic_Tran_Center.webp', price: 1500 }
      ],
      type: "Clock"
    },

    // --- 2. CryptoClock Saving (เลือกสี: ดำ ขาว ส้ม) ---
    {
      id: 'cryptoclock-saving',
      title: "CryptoClock Saving",
      price: 990,
      description: "รุ่นประหยัดเน้นการใช้งานหลัก แสดงราคาตัวเลขขนาดใหญ่ชัดเจน ไม่มีฟังก์ชันซับซ้อน กินไฟน้อย",
      specs: ["7-Segment Display", "Low Power", "Plug & Play"],
      images: ["/images/cryptoclock-saving.webp"],
      variantType: "color",
      variants: [
        { name: 'White', color: '#F0F0F0', image: '/images/cryptoclock-saving.webp', price: 990 },
        { name: 'Black', color: '#111111', image: '/images/cryptoclock-saving.webp', price: 990 },
        { name: 'Orange', color: '#D4AF37', image: '/images/cryptoclock-saving.webp', price: 990 }
      ],
      type: "Clock"
    },

    // --- 3. CryptoClock Pro (เลือก Pro หรือ Pro + NFC) ---
    {
      id: 'cryptoclock-pro',
      title: "CryptoClock Pro",
      price: 2500,
      description: "รุ่น Pro อัปเกรดหน้าจอเป็น IPS ความละเอียดสูง แสดงกราฟแท่งเทียนได้ พร้อมระบบแจ้งเตือนราคา",
      specs: ["High-Res IPS Screen", "Candlestick Charts", "Price Alerts"],
      images: ["/images/cryptoclock-pro.webp"],
      variantType: "text", // ปุ่มข้อความ
      variants: [
        { name: 'Pro Standard', image: '/images/cryptoclock-pro.webp', price: 2500 },
        { name: 'Pro + NFC', image: '/images/cryptoclock-pro.webp', price: 3200 }
      ],
      type: "Clock"
    },

    // --- 4. BiTTerm (มี 3 รุ่น + Option PromptPay) ---
    {
      id: 'bitterm-series', 
      title: "BiTTerm Series",
      price: 15000,
      description: "ตู้เติม Bitcoin สำหรับร้านค้า รับเงินสดแลกเป็น Bitcoin ผ่าน Lightning Network มีให้เลือกหลายขนาดเพื่อรองรับธุรกิจทุกระดับ",
      specs: ["Lightning Network", "Cash Acceptor", "Thermal Printer", "Wifi/4G"],
      images: ["/images/bitterm-mini.webp"],
      variantType: "text",
      variants: [
        { name: 'BiTTerm Mini', image: '/images/bitterm-mini.webp', price: 15000 },
        { name: 'BiTTerm Pro', image: '/images/bitterm-mini.webp', price: 25000 },
        { name: 'BiTTerm Pro Max', image: '/images/bitterm-mini.webp', price: 39000 }
      ],
      addons: [
        { id: 'promptpay', name: 'PromptPay Module', price: 8500, desc: 'รองรับการสแกนจ่ายเงินบาท (QR PromptPay)' }
      ],
      type: "Kiosk"
    },

    // --- 5. BiTNode (เลือก RPi หรือ Umbrel Home) ---
    {
      id: 'bitnode-personal',
      title: "BiTNode Personal",
      price: 5500,
      description: "อุปกรณ์รัน Bitcoin Full Node แบบสำเร็จรูป เลือกได้ระหว่างชุด Kit ประหยัด หรือเครื่องระดับ High-End",
      specs: ["Pre-synced Blockchain", "2TB SSD", "Umbrel OS Ready"],
      images: ["/images/bitnode-personal.webp"],
      variantType: "text",
      variants: [
        { name: 'Raspberry Pi 5 Kit', image: '/images/bitnode-personal.webp', price: 5500 },
        { name: 'Umbrel Home Server', image: '/images/bitnode-personal.webp', price: 24900 }
      ],
      type: "Node"
    },

    // --- สินค้าอื่นๆ (คงเดิม) ---
    {
      id: 'cryptoclock-promax',
      title: "CryptoClock Pro Max",
      price: 3500,
      description: "ที่สุดของนาฬิกาคริปโต หน้าจอขนาดใหญ่พิเศษ",
      specs: ["Large IPS Display", "Portfolio Tracking"],
      images: ["/images/cryptoclock-promax.webp"],
      type: "Clock"
    },
    {
      id: 'bitpos-terminal',
      title: "BiTPos Terminal",
      price: 8900,
      description: "เครื่องคิดเงินอัจฉริยะ รองรับ Bitcoin และ Lightning",
      specs: ["Touch Screen 5.5\"", "Built-in Printer", "NFC"],
      images: ["/images/bitpos-terminal.webp"],
      type: "POS"
    },
    {
      id: 'cryptoclock-epaper',
      title: "CryptoClock ePaper",
      price: 4500,
      description: "หน้าจอ E-Ink ถนอมสายตา",
      specs: ["E-Ink Display", "Battery Life 1 Month"],
      images: ["/images/cryptoclock-epaper-47.webp"],
      variantType: "text",
      variants: [
        { name: '4.7 Inch', image: '/images/cryptoclock-epaper-47.webp', price: 4500 },
        { name: '7.5 Inch', image: '/images/cryptoclock-epaper-75.webp', price: 6500 }
      ],
      type: "Clock"
    }
  ];

  return products.map(product => ({
    params: { id: product.id },
    props: { product },
  }));
}

const { product } = Astro.props;
---

<Layout title={`${product.title} | Cashless Thailand`}>
    <Navbar />
    <CartDrawer />

    <main class="relative z-10 bg-[#050505] pt-32 pb-20 min-h-screen">
        <div class="max-w-[1200px] mx-auto px-6 mb-8">
            <a href="/shop" class="text-white/40 hover:text-[#D4AF37] text-xs eng uppercase tracking-widest transition-colors">Shop</a>
            <span class="text-white/20 mx-2">/</span>
            <span class="text-[#D4AF37] text-xs eng uppercase tracking-widest">{product.title}</span>
        </div>

        <div class="max-w-[1200px] mx-auto px-6 grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-20">
            <div class="space-y-4">
                <div class="aspect-square bg-[#111] rounded-[2rem] overflow-hidden border border-white/5 relative group flex items-center justify-center p-8">
                    <img 
                        id="main-image" 
                        src={product.images[0]} 
                        alt={product.title} 
                        class="w-full h-full object-contain transition-all duration-500 group-hover:scale-105" 
                    />
                </div>
            </div>

            <div class="flex flex-col justify-center">
                <h1 class="text-3xl md:text-5xl font-black text-white leading-tight mb-4">{product.title}</h1>
                <div class="flex items-end gap-4 mb-8">
                    <span id="price-display" class="text-3xl text-[#D4AF37] font-black eng">{product.price.toLocaleString()}</span>
                    <span class="text-3xl text-[#D4AF37] font-black eng"> THB</span>
                </div>
                <p class="text-white/60 font-light leading-relaxed mb-8 text-lg">{product.description}</p>
                
                {product.variants && (
                    <div class="mb-8">
                        <span class="text-xs font-bold text-white/40 uppercase tracking-widest block mb-3">
                            {product.variantType === 'color' ? 'Select Color' : 'Select Model'}
                        </span>
                        
                        <div class="flex gap-3 flex-wrap" id="variant-selector">
                            {product.variants.map((variant, index) => (
                                product.variantType === 'color' ? (
                                    <button 
                                        class={`variant-btn w-10 h-10 rounded-full border-2 transition-all duration-300 relative group ${index === 0 ? 'border-[#D4AF37] scale-110 active-variant' : 'border-transparent hover:scale-110'}`}
                                        style={`background-color: ${variant.color}`}
                                        data-image={variant.image}
                                        data-name={variant.name}
                                        data-price={variant.price}
                                        aria-label={variant.name}
                                    >
                                        <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                                            {variant.name}
                                        </span>
                                    </button>
                                ) : (
                                    <button 
                                        class={`variant-btn px-6 py-3 rounded-xl border transition-all duration-300 font-bold text-sm eng uppercase tracking-wider ${index === 0 ? 'bg-[#D4AF37] text-black border-[#D4AF37] active-variant' : 'bg-white/5 text-white/60 border-white/10 hover:border-[#D4AF37] hover:text-white'}`}
                                        data-image={variant.image}
                                        data-name={variant.name}
                                        data-price={variant.price}
                                    >
                                        {variant.name}
                                    </button>
                                )
                            ))}
                        </div>
                    </div>
                )}

                {product.addons && (
                    <div class="mb-8 border-t border-white/10 pt-6">
                        <span class="text-xs font-bold text-white/40 uppercase tracking-widest block mb-3">Extra Options</span>
                        <div class="space-y-3">
                            {product.addons.map((addon) => (
                                <label class="flex items-center justify-between p-4 rounded-xl bg-white/5 border border-white/10 cursor-pointer hover:border-[#D4AF37]/50 transition-colors group">
                                    <div class="flex items-center gap-4">
                                        <div class="relative flex items-center">
                                            <input type="checkbox" class="addon-checkbox peer appearance-none w-6 h-6 border-2 border-white/20 rounded bg-transparent checked:bg-[#D4AF37] checked:border-[#D4AF37] transition-all" 
                                                data-price={addon.price} 
                                                data-name={addon.name} 
                                            />
                                            <svg class="absolute w-4 h-4 text-black pointer-events-none opacity-0 peer-checked:opacity-100 left-1 top-1 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                        </div>
                                        <div>
                                            <span class="block text-white font-bold text-sm">{addon.name}</span>
                                            <span class="block text-white/40 text-xs mt-0.5">{addon.desc}</span>
                                        </div>
                                    </div>
                                    <span class="text-[#D4AF37] font-bold text-sm">+ {addon.price.toLocaleString()} ฿</span>
                                </label>
                            ))}
                        </div>
                    </div>
                )}

                <ul class="space-y-3 mb-12">
                    {product.specs.map(spec => (
                        <li class="flex items-center gap-3 text-white/80">
                            <span class="text-[#D4AF37]">•</span> <span>{spec}</span>
                        </li>
                    ))}
                </ul>

                <div class="flex gap-4 h-14">
                    <div class="flex items-center bg-white/5 border border-white/10 rounded-xl px-2 w-32 justify-between">
                        <button id="qty-minus" class="text-white/50 hover:text-white w-8 h-full flex items-center justify-center text-xl transition-colors">-</button>
                        <input id="qty-input" type="number" value="1" min="1" class="w-10 bg-transparent text-center text-white font-bold outline-none appearance-none" readonly />
                        <button id="qty-plus" class="text-white/50 hover:text-white w-8 h-full flex items-center justify-center text-xl transition-colors">+</button>
                    </div>
                    
                    <button 
                        id="add-to-cart-btn"
                        class="flex-1 bg-[#D4AF37] text-black rounded-xl font-black uppercase tracking-wider hover:bg-[#b8962e] transition-all shadow-[0_0_20px_rgba(212,175,55,0.3)] hover:shadow-[0_0_40px_rgba(212,175,55,0.5)] active:scale-95"
                        data-base-id={product.id}
                        data-base-title={product.title}
                        data-base-price={product.price}
                        data-image={product.images[0]} 
                    >
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </main>
    <Footer />
</Layout>

<script>
    import { cartStore } from '../../scripts/cartStore.js';

    function initProductPage() {
        const mainImage = document.getElementById('main-image');
        const priceDisplay = document.getElementById('price-display');
        const variantBtns = document.querySelectorAll('.variant-btn');
        const addonCheckboxes = document.querySelectorAll('.addon-checkbox');
        
        let currentVariant = variantBtns.length > 0 ? {
            name: variantBtns[0].getAttribute('data-name'),
            price: parseFloat(variantBtns[0].getAttribute('data-price') || '0'),
            image: variantBtns[0].getAttribute('data-image')
        } : null;

        let selectedAddons = [];

        const updateTotalPrice = () => {
            let total = 0;
            if (currentVariant) {
                total += currentVariant.price;
            } else {
                const btn = document.getElementById('add-to-cart-btn');
                // @ts-ignore
                total += parseFloat(btn?.dataset.basePrice || '0');
            }
            // @ts-ignore
            const addonTotal = selectedAddons.reduce((sum, item) => sum + item.price, 0);
            total += addonTotal;

            if (priceDisplay) {
                priceDisplay.innerText = total.toLocaleString();
                priceDisplay.style.opacity = '0.5';
                setTimeout(() => priceDisplay.style.opacity = '1', 100);
            }
            return total;
        };

        variantBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                variantBtns.forEach(b => {
                    if (b.classList.contains('rounded-full')) {
                        b.classList.remove('border-[#D4AF37]', 'scale-110', 'active-variant');
                        b.classList.add('border-transparent');
                    } else {
                        b.classList.remove('bg-[#D4AF37]', 'text-black', 'border-[#D4AF37]', 'active-variant');
                        b.classList.add('bg-white/5', 'text-white/60', 'border-white/10');
                    }
                });

                // @ts-ignore
                const target = e.currentTarget;
                target.classList.add('active-variant');
                if (target.classList.contains('rounded-full')) {
                    target.classList.remove('border-transparent');
                    target.classList.add('border-[#D4AF37]', 'scale-110');
                } else {
                    target.classList.remove('bg-white/5', 'text-white/60', 'border-white/10');
                    target.classList.add('bg-[#D4AF37]', 'text-black', 'border-[#D4AF37]');
                }

                currentVariant = {
                    name: target.getAttribute('data-name'),
                    price: parseFloat(target.getAttribute('data-price') || '0'),
                    image: target.getAttribute('data-image')
                };

                if (mainImage && currentVariant.image) {
                    mainImage.style.opacity = '0';
                    setTimeout(() => {
                        mainImage.setAttribute('src', currentVariant.image);
                        mainImage.style.opacity = '1';
                    }, 200);
                }
                updateTotalPrice();
            });
        });

        addonCheckboxes.forEach(chk => {
            chk.addEventListener('change', (e) => {
                // @ts-ignore
                const target = e.target;
                const name = target.getAttribute('data-name');
                const price = parseFloat(target.getAttribute('data-price') || '0');

                if (target.checked) {
                    // @ts-ignore
                    selectedAddons.push({ name, price });
                } else {
                    // @ts-ignore
                    selectedAddons = selectedAddons.filter(a => a.name !== name);
                }
                updateTotalPrice();
            });
        });

        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const mobileAddToCartBtn = document.getElementById('add-to-cart-mobile');
        
        const handleAddToCart = (e, btn) => {
            e.preventDefault();
            const baseId = btn.dataset.baseId;
            const baseTitle = btn.dataset.baseTitle;
            const baseImage = btn.dataset.image;
            const finalPrice = updateTotalPrice();

            let finalTitle = baseTitle;
            let finalId = baseId;

            if (currentVariant) {
                finalTitle = `${currentVariant.name}`; 
                finalId += `-${currentVariant.name.replace(/\s+/g, '-').toLowerCase()}`;
            }

            if (selectedAddons.length > 0) {
                const addonNames = selectedAddons.map(a => a.name).join(' + ');
                finalTitle += ` (+ ${addonNames})`;
                finalId += `-addon`;
            }

            const productToAdd = {
                id: finalId,
                title: finalTitle,
                price: finalPrice,
                image: currentVariant ? currentVariant.image : baseImage
            };

            const qtyInput = document.getElementById('qty-input');
            // @ts-ignore
            const qty = parseInt(qtyInput?.value || '1');
            
            for(let i=0; i < qty; i++) {
                cartStore.add(productToAdd);
            }

            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = 'scale(1)', 150);
        };

        if(addToCartBtn) addToCartBtn.addEventListener('click', (e) => handleAddToCart(e, addToCartBtn));
        if(mobileAddToCartBtn) mobileAddToCartBtn.addEventListener('click', (e) => handleAddToCart(e, mobileAddToCartBtn));

        const qtyInput = document.getElementById('qty-input');
        let currentQty = 1;
        document.getElementById('qty-minus')?.addEventListener('click', () => {
             if (currentQty > 1) { currentQty--; if(qtyInput) qtyInput.value = currentQty.toString(); }
        });
        document.getElementById('qty-plus')?.addEventListener('click', () => {
             currentQty++; if(qtyInput) qtyInput.value = currentQty.toString();
        });
    }

    document.addEventListener('astro:page-load', initProductPage);
</script>