---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import { supabase } from "../../lib/supabase";
import SellerProductManager from "../../components/seller/SellerProductManager";

// Server-side: Only check Supabase session
// Wallet users will be handled client-side
const {
    data: { session },
} = await supabase.auth.getSession();

let shop = null;
if (session) {
    const { data } = await supabase
        .from("shops")
        .select("*")
        .eq("owner_id", session.user.id)
        .single();
    shop = data;
}
---

<!-- Loading overlay for wallet users -->
<div
    id="wallet-loading"
    style="display: none;"
    class="fixed inset-0 bg-[#050505] z-50 flex items-center justify-center"
>
    <div class="text-center">
        <div
            class="w-16 h-16 border-4 border-[#D4AF37]/20 border-t-[#D4AF37] rounded-full animate-spin mx-auto mb-4"
        >
        </div>
        <p class="text-white/60 text-sm">Loading...</p>
    </div>
</div>

<Layout title={`Products | ${shop?.name || "My Shop"}`}>
    <Navbar />
    <div class="flex h-screen bg-[#050505] overflow-hidden pt-24">
        <!-- Sidebar -->
        <aside
            class="w-64 bg-[#111] border-r border-white/10 hidden md:flex flex-col"
        >
            <div class="p-6 border-b border-white/10">
                <h2
                    class="text-[#D4AF37] font-black uppercase tracking-widest text-lg"
                >
                    Seller Center
                </h2>
                <p class="text-white/40 text-xs mt-1 truncate">
                    {shop?.name || "Loading..."}
                </p>
            </div>

            <nav class="flex-1 p-4 space-y-2">
                <a
                    href="/seller/dashboard"
                    class="flex items-center gap-3 px-4 py-3 text-white/60 hover:text-white hover:bg-white/5 rounded-xl font-bold text-sm transition-all"
                >
                    <span>ğŸ“Š</span> Dashboard
                </a>
                <a
                    href="/seller/orders"
                    class="flex items-center gap-3 px-4 py-3 text-white/60 hover:text-white hover:bg-white/5 rounded-xl font-bold text-sm transition-all"
                >
                    <span>ğŸ“¦</span> Orders
                </a>
                <a
                    href="/chat"
                    class="flex items-center gap-3 px-4 py-3 text-white/60 hover:text-white hover:bg-white/5 rounded-xl font-bold text-sm transition-all"
                >
                    <span>ğŸ’¬</span> Messages
                </a>
                <a
                    href="/seller/products"
                    class="flex items-center gap-3 px-4 py-3 bg-[#D4AF37]/10 text-[#D4AF37] rounded-xl font-bold text-sm"
                >
                    <span>ğŸ·ï¸</span> Products
                </a>
                <a
                    href="/seller/settings"
                    class="flex items-center gap-3 px-4 py-3 text-white/60 hover:text-white hover:bg-white/5 rounded-xl font-bold text-sm transition-all"
                >
                    <span>âš™ï¸</span> Settings
                </a>
            </nav>

            <div class="p-4 border-t border-white/10">
                <a
                    href="/"
                    class="flex items-center gap-2 text-white/40 hover:text-white text-xs font-bold uppercase tracking-widest transition-colors"
                >
                    â† Back to Market
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto relative bg-[#050505]">
            <!-- Mobile Header -->
            <div
                class="md:hidden p-4 border-b border-white/10 flex justify-between items-center bg-[#111]"
            >
                <span class="text-[#D4AF37] font-black uppercase">Products</span
                >
                <a href="/seller/dashboard" class="text-xs text-white/60"
                    >Back</a
                >
            </div>

            <div class="p-4 md:p-8 max-w-7xl mx-auto">
                <SellerProductManager shopId={shop?.id} client:only="react" />
            </div>
        </main>
    </div>
</Layout>

<script>
    import "../../lib/sellerAuthGuard.js";
</script>
