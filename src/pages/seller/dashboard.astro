---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import { supabase } from "../../lib/supabase";

const {
    data: { session },
} = await supabase.auth.getSession();

let shop = null;
if (session) {
    const { data } = await supabase
        .from("shops")
        .select("*")
        .eq("owner_id", session.user.id)
        .single();
    shop = data;

    // Server-side redirect if shop is pending
    if (shop && shop.status !== "active") {
        return Astro.redirect("/seller/pending");
    }

    // If no shop exists, redirect to registration
    if (!shop) {
        return Astro.redirect("/seller/register");
    }
}

import SellerSidebar from "../../components/seller/SellerSidebar.astro";
import SellerDashboardStats from "../../components/seller/SellerDashboardStats";
---

<Layout title={shop ? `Dashboard | ${shop.name}` : "Seller Dashboard"}>
    <Navbar />

    <!-- Loading overlay for wallet users -->
    <div
        id="wallet-loading"
        style="display: none;"
        class="fixed inset-0 bg-[#050505] z-50 flex items-center justify-center pointer-events-none"
    >
        <div class="text-center">
            <div
                class="w-16 h-16 border-4 border-[#D4AF37]/20 border-t-[#D4AF37] rounded-full animate-spin mx-auto mb-4"
            >
            </div>
            <p class="text-white/60 text-sm">Loading dashboard...</p>
        </div>
    </div>

    <div
        id="dashboard-content"
        class="flex h-screen bg-[#050505] overflow-hidden pt-24"
    >
        <SellerSidebar activeTab="dashboard" shop={shop} />

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Mobile Header -->
            <div
                class="md:hidden p-4 border-b border-white/10 flex justify-between items-center bg-[#111]"
            >
                <span class="text-[#D4AF37] font-black uppercase"
                    >Dashboard</span
                >
                <a href="/" class="text-xs text-white/60">Home</a>
            </div>

            <div class="p-4 md:p-8 max-w-7xl mx-auto space-y-8">
                <header class="hidden md:block">
                    <h1
                        id="shop-name-header"
                        class="text-3xl font-black text-white"
                    >
                        {shop?.name || "My Shop"} Overview
                    </h1>
                </header>

                <!-- Stats Grid (Dynamic) -->
                <SellerDashboardStats shopId={shop?.id} client:only="react" />

                <!-- Quick Actions -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div
                        class="bg-[#111] border border-white/10 rounded-2xl p-6"
                    >
                        <h3 class="text-xl font-bold text-[#D4AF37] mb-4">
                            Add Product
                        </h3>
                        <p class="text-white/60 mb-6">
                            List a new item to the marketplace. Support simple
                            and variable products.
                        </p>
                        <a
                            href="/seller/products"
                            class="inline-block px-6 py-3 bg-[#D4AF37] hover:bg-[#B8941F] text-black font-bold rounded-xl transition-all"
                        >
                            + New Product
                        </a>
                    </div>

                    <div
                        class="bg-[#111] border border-white/10 rounded-2xl p-6"
                    >
                        <h3 class="text-xl font-bold text-[#D4AF37] mb-4">
                            Shop Customization
                        </h3>
                        <p class="text-white/60 mb-6">
                            Update your logo, banner and store description to
                            attract customers.
                        </p>
                        <a
                            href="/seller/settings"
                            class="inline-block px-6 py-3 border-2 border-[#D4AF37]/50 hover:border-[#D4AF37] text-[#D4AF37] font-bold rounded-xl transition-all"
                        >
                            Edit Shop
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>
</Layout>

<script>
    import "../../lib/sellerAuthGuard.js";
</script>
