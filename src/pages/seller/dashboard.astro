---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import { supabase } from "../../lib/supabase";

const {
    data: { session },
} = await supabase.auth.getSession();

let shop = null;
if (session) {
    const { data } = await supabase
        .from("shops")
        .select("*")
        .eq("owner_id", session.user.id)
        .single();
    shop = data;
}

import SellerDashboardStats from "../../components/seller/SellerDashboardStats";
---

<Layout title={shop ? `Dashboard | ${shop.name}` : "Seller Dashboard"}>
    <Navbar />

    <!-- Loading overlay for wallet users -->
    <div
        id="wallet-loading"
        style="display: none;"
        class="fixed inset-0 bg-[#050505] z-50 flex items-center justify-center"
    >
        <div class="text-center">
            <div
                class="w-16 h-16 border-4 border-[#D4AF37]/20 border-t-[#D4AF37] rounded-full animate-spin mx-auto mb-4"
            >
            </div>
            <p class="text-white/60 text-sm">Loading dashboard...</p>
        </div>
    </div>

    <div
        id="dashboard-content"
        class="flex h-screen bg-[#050505] overflow-hidden pt-24"
    >
        <!-- Sidebar -->
        <aside
            class="w-64 bg-[#111] border-r border-white/10 hidden md:flex flex-col"
        >
            <div class="p-6 border-b border-white/10">
                <h2
                    class="text-[#D4AF37] font-black uppercase tracking-widest text-lg"
                >
                    Seller Center
                </h2>
                <p
                    id="shop-name-sidebar"
                    class="text-white/40 text-xs mt-1 truncate"
                >
                    {shop?.name || "Loading..."}
                </p>
            </div>

            <nav class="flex-1 p-4 space-y-2">
                <a
                    href="/seller/dashboard"
                    class="flex items-center gap-3 px-4 py-3 bg-[#D4AF37]/10 text-[#D4AF37] rounded-xl font-bold text-sm"
                >
                    <span>üìä</span> Dashboard
                </a>
                <a
                    href="/seller/orders"
                    class="flex items-center gap-3 px-4 py-3 text-white/60 hover:text-white hover:bg-white/5 rounded-xl font-bold text-sm transition-all"
                >
                    <span>üì¶</span> Orders
                </a>
                <a
                    href="/chat"
                    class="flex items-center gap-3 px-4 py-3 text-white/60 hover:text-white hover:bg-white/5 rounded-xl font-bold text-sm transition-all"
                >
                    <span>üí¨</span> Messages
                </a>
                <a
                    href="/seller/products"
                    class="flex items-center gap-3 px-4 py-3 text-white/60 hover:text-white hover:bg-white/5 rounded-xl font-bold text-sm transition-all"
                >
                    <span>üè∑Ô∏è</span> Products
                </a>
                <a
                    href="/seller/settings"
                    class="flex items-center gap-3 px-4 py-3 text-white/60 hover:text-white hover:bg-white/5 rounded-xl font-bold text-sm transition-all"
                >
                    <span>‚öôÔ∏è</span> Settings
                </a>
            </nav>

            <div class="p-4 border-t border-white/10">
                <a
                    href="/"
                    class="flex items-center gap-2 text-white/40 hover:text-white text-xs font-bold uppercase tracking-widest transition-colors"
                >
                    ‚Üê Back to Market
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div class="p-8">
                <h1
                    id="shop-name-header"
                    class="text-3xl font-black text-white mb-8"
                >
                    {shop?.name || "My Shop"} Overview
                </h1>

                <!-- Stats Grid (Dynamic) -->
                <SellerDashboardStats shopId={shop?.id} client:only="react" />

                <!-- Quick Actions -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div
                        class="bg-[#111] border border-white/10 rounded-2xl p-6"
                    >
                        <h3 class="text-xl font-bold text-[#D4AF37] mb-4">
                            Add Product
                        </h3>
                        <p class="text-white/60 mb-6">
                            List a new item to the marketplace. Support simple
                            and variable products.
                        </p>
                        <a
                            href="/seller/products"
                            class="inline-block px-6 py-3 bg-[#D4AF37] hover:bg-[#B8941F] text-black font-bold rounded-xl transition-all"
                        >
                            + New Product
                        </a>
                    </div>

                    <div
                        class="bg-[#111] border border-white/10 rounded-2xl p-6"
                    >
                        <h3 class="text-xl font-bold text-[#D4AF37] mb-4">
                            Shop Customization
                        </h3>
                        <p class="text-white/60 mb-6">
                            Update your logo, banner and store description to
                            attract customers.
                        </p>
                        <a
                            href="/seller/settings"
                            class="inline-block px-6 py-3 border-2 border-[#D4AF37]/50 hover:border-[#D4AF37] text-[#D4AF37] font-bold rounded-xl transition-all"
                        >
                            Edit Shop
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>
</Layout>

<script>
    import "../../lib/sellerAuthGuard.js";
</script>
