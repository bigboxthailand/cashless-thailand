---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";
import SellerSidebar from "../../components/seller/SellerSidebar.astro";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
);

// Auth & Shop Check (Lenient for wallet users)
const {
    data: { session },
} = await supabase.auth.getSession();

let shop = null;
if (session?.user) {
    const { data } = await supabase
        .from("shops")
        .select("*")
        .eq("owner_id", session.user.id)
        .single();
    shop = data;

    if (shop && shop.status !== "active") {
        return Astro.redirect("/seller/pending");
    }
}

// Note: If shop is null (wallet user), data fetching below will be skipped on server
// and handled by client-side script.

// Fetch Data only if shop exists on server
let stats = {
    total_sales: 0,
    pending_payouts: 0,
    paid_payouts: 0,
    available_balance: 0,
};
let payouts = [];

if (shop) {
    const { data: financeData } = await supabase
        .from("shop_finance_view")
        .select("*")
        .eq("shop_id", shop.id)
        .single();

    if (financeData) {
        stats.total_sales = financeData.total_sales || 0;
        stats.pending_payouts = financeData.pending_payouts || 0;
        stats.paid_payouts = financeData.paid_payouts || 0;
        stats.available_balance =
            stats.total_sales - (stats.pending_payouts + stats.paid_payouts);
    }

    // Fetch Payout History
    const { data: payoutsData } = await supabase
        .from("payouts")
        .select("*")
        .eq("shop_id", shop.id)
        .order("created_at", { ascending: false });
    payouts = payoutsData || [];
}

const thb = new Intl.NumberFormat("th-TH", {
    style: "currency",
    currency: "THB",
});
---

<Layout title="Seller Wallet">
    <Navbar />

    <!-- Loading overlay -->
    <div
        id="wallet-loading"
        style="display: none;"
        class="fixed inset-0 bg-[#050505] z-50 flex items-center justify-center pointer-events-none"
    >
        <div class="text-center">
            <div
                class="w-16 h-16 border-4 border-[#D4AF37]/20 border-t-[#D4AF37] rounded-full animate-spin mx-auto mb-4"
            >
            </div>
            <p class="text-white/60 text-sm">Loading Wallet...</p>
        </div>
    </div>

    <div class="flex h-screen bg-[#050505] overflow-hidden pt-24">
        <SellerSidebar activeTab="wallet" shop={shop} />

        <main class="flex-1 overflow-y-auto bg-[#050505]">
            <!-- Mobile Header -->
            <div
                class="md:hidden p-4 border-b border-white/10 flex justify-between items-center bg-[#111]"
            >
                <span class="text-[#D4AF37] font-black uppercase"
                    >Wallet & Payout</span
                >
                <a href="/seller/dashboard" class="text-xs text-white/60"
                    >Back</a
                >
            </div>

            <div class="p-4 md:p-8 max-w-5xl mx-auto space-y-8">
                <header class="hidden md:block">
                    <h1
                        class="text-3xl font-black text-white uppercase tracking-wider"
                    >
                        My Wallet
                    </h1>
                    <p class="text-white/50" id="wallet-shop-name">
                        {shop?.name || "Loading..."}
                    </p>
                </header>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Available Balance -->
                    <div
                        class="p-6 rounded-2xl bg-gradient-to-br from-[#D4AF37]/20 to-black border border-[#D4AF37]/30"
                    >
                        <h3
                            class="text-[#D4AF37] uppercase text-xs font-bold tracking-widest mb-2"
                        >
                            Available Balance
                        </h3>
                        <p
                            class="text-4xl font-black text-white"
                            id="stat-balance"
                        >
                            {thb.format(stats.available_balance)}
                        </p>
                        <p class="text-xs text-white/40 mt-2">
                            Ready to withdraw
                        </p>
                    </div>

                    <!-- Total Sales -->
                    <div
                        class="p-6 rounded-2xl bg-[#111] border border-white/10"
                    >
                        <h3
                            class="text-white/50 uppercase text-xs font-bold tracking-widest mb-2"
                        >
                            Total Earnings
                        </h3>
                        <p
                            class="text-3xl font-bold text-white"
                            id="stat-earnings"
                        >
                            {thb.format(stats.total_sales)}
                        </p>
                        <p class="text-xs text-white/40 mt-2">
                            Gross Revenue (Paid Orders)
                        </p>
                    </div>

                    <!-- Pending -->
                    <div
                        class="p-6 rounded-2xl bg-[#111] border border-white/10"
                    >
                        <h3
                            class="text-white/50 uppercase text-xs font-bold tracking-widest mb-2"
                        >
                            Pending Payout
                        </h3>
                        <p
                            class="text-3xl font-bold text-orange-400"
                            id="stat-pending"
                        >
                            {thb.format(stats.pending_payouts)}
                        </p>
                        <p class="text-xs text-white/40 mt-2">Processing</p>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Request Form -->
                    <div
                        class="bg-[#111] p-8 rounded-2xl border border-white/10"
                    >
                        <h2 class="text-xl font-bold text-white mb-6">
                            Request Payout
                        </h2>
                        <form
                            id="payout-form"
                            class="space-y-4"
                            data-shop-id={shop?.id}
                        >
                            <div>
                                <label
                                    class="block text-xs uppercase font-bold text-white/50 mb-2"
                                    >Amount (THB)</label
                                >
                                <input
                                    type="number"
                                    name="amount"
                                    min="100"
                                    max={stats.available_balance}
                                    placeholder="Min 100 THB"
                                    class="w-full bg-black border border-white/10 p-3 rounded-xl text-white outline-none focus:border-[#D4AF37]"
                                    required
                                />
                                <p class="text-xs text-white/30 mt-1">
                                    Maximum: {stats.available_balance} THB
                                </p>
                            </div>
                            <div>
                                <label
                                    class="block text-xs uppercase font-bold text-white/50 mb-2"
                                    >Bank Details</label
                                >
                                <textarea
                                    name="bank_info"
                                    rows="3"
                                    placeholder="Bank Name, Account Number, Account Name"
                                    class="w-full bg-black border border-white/10 p-3 rounded-xl text-white outline-none focus:border-[#D4AF37]"
                                    required></textarea>
                            </div>
                            <button
                                type="submit"
                                class="w-full py-3 bg-[#D4AF37] text-black font-bold uppercase tracking-wider rounded-xl hover:brightness-110 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Submit Request
                            </button>
                        </form>
                    </div>

                    <!-- History -->
                    <div
                        class="bg-[#111] p-8 rounded-2xl border border-white/10"
                    >
                        <h2 class="text-xl font-bold text-white mb-6">
                            Payout History
                        </h2>
                        <div
                            id="payout-history-list"
                            class="space-y-4 max-h-[400px] overflow-y-auto pr-2"
                        >
                            {
                                (payouts || []).map((payout) => (
                                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
                                        <div>
                                            <p class="font-bold text-white">
                                                {thb.format(payout.amount)}
                                            </p>
                                            <p class="text-xs text-white/40">
                                                {new Date(
                                                    payout.created_at,
                                                ).toLocaleDateString()}
                                            </p>
                                        </div>
                                        <div>
                                            <span
                                                class={`px-3 py-1 rounded-full text-[10px] uppercase font-black tracking-wider 
                                        ${
                                            payout.status === "paid"
                                                ? "bg-green-500/20 text-green-400"
                                                : payout.status === "rejected"
                                                  ? "bg-red-500/20 text-red-400"
                                                  : "bg-orange-500/20 text-orange-400"
                                        }`}
                                            >
                                                {payout.status}
                                            </span>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</Layout>

<script>
    import { createClient } from "@supabase/supabase-js";
    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
    );

    const form = document.getElementById("payout-form");

    // Client-side initialization for wallet users
    const initWalletData = async () => {
        // Find shop ID if not provided by server
        let shopId = form?.dataset.shopId;
        if (!shopId) {
            const wallet = localStorage.getItem("user_wallet");
            if (!wallet) return;

            const { data: profile } = await supabase
                .from("profiles")
                .select("id")
                .eq("wallet_address", wallet)
                .single();
            if (profile) {
                const { data: shop } = await supabase
                    .from("shops")
                    .select("*")
                    .eq("owner_id", profile.id)
                    .single();
                if (shop) {
                    shopId = shop.id;
                    if (form) form.dataset.shopId = shop.id;
                    const nameEl = document.getElementById("wallet-shop-name");
                    if (nameEl) nameEl.textContent = shop.name;
                }
            }
        }

        if (shopId) {
            // Fetch stats client-side
            const { data: financeData } = await supabase
                .from("shop_finance_view")
                .select("*")
                .eq("shop_id", shopId)
                .single();

            if (financeData) {
                const thb = new Intl.NumberFormat("th-TH", {
                    style: "currency",
                    currency: "THB",
                });
                const totalSales = financeData.total_sales || 0;
                const pending = financeData.pending_payouts || 0;
                const paid = financeData.paid_payouts || 0;
                const available = totalSales - (pending + paid);

                const balEl = document.getElementById("stat-balance");
                const earnEl = document.getElementById("stat-earnings");
                const pendEl = document.getElementById("stat-pending");

                if (balEl) balEl.textContent = thb.format(available);
                if (earnEl) earnEl.textContent = thb.format(totalSales);
                if (pendEl) pendEl.textContent = thb.format(pending);

                // Update input max
                const input = form?.querySelector('input[name="amount"]');
                if (input) input.setAttribute("max", available.toString());

                // Fetch and Render Payout History
                const { data: payouts } = await supabase
                    .from("payouts")
                    .select("*")
                    .eq("shop_id", shopId)
                    .order("created_at", { ascending: false });

                if (payouts && payouts.length > 0) {
                    const historyContainer = document.getElementById(
                        "payout-history-list",
                    );
                    if (historyContainer) {
                        historyContainer.innerHTML = payouts
                            .map(
                                (payout) => `
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
                                <div>
                                    <p class="font-bold text-white">
                                        ${thb.format(payout.amount)}
                                    </p>
                                    <p class="text-xs text-white/40">
                                        ${new Date(payout.created_at).toLocaleDateString()}
                                    </p>
                                </div>
                                <div>
                                    <span class="px-3 py-1 rounded-full text-[10px] uppercase font-black tracking-wider 
                                        ${
                                            payout.status === "paid"
                                                ? "bg-green-500/20 text-green-400"
                                                : payout.status === "rejected"
                                                  ? "bg-red-500/20 text-red-400"
                                                  : "bg-orange-500/20 text-orange-400"
                                        }">
                                        ${payout.status}
                                    </span>
                                </div>
                            </div>
                        `,
                            )
                            .join("");
                    }
                }
            }
        }
    };

    initWalletData();

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const btn = form.querySelector("button");
        if (btn) {
            btn.disabled = true;
            btn.innerText = "Submitting...";
        }

        const initialShopId = form.dataset.shopId;
        if (!initialShopId) {
            alert("Shop ID not found. Please reload.");
            return;
        }

        // Using standard JS instead of TS casting for safety
        const formElement =
            e.target instanceof HTMLFormElement ? e.target : null;
        if (!formElement) return;

        const formData = new FormData(formElement);
        const amount = parseFloat((formData.get("amount") || "0").toString());
        const bankInfo = { details: formData.get("bank_info") };

        const { error } = await supabase.from("payouts").insert({
            shop_id: initialShopId,
            amount: amount,
            bank_info: bankInfo,
            status: "pending",
        });

        if (error) {
            alert("Request failed: " + error.message);
            if (btn) {
                btn.disabled = false;
                btn.innerText = "Submit Request";
            }
        } else {
            alert("Payout requested successfully!");
            window.location.reload();
        }
    });
</script>
