---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";
import BlogInteractions from "../../components/blog/BlogInteractions.jsx";
import { supabase } from "../../lib/supabase";

export async function getStaticPaths() {
    const { data: posts } = await supabase.from("blog_posts").select("slug");
    return (posts || []).map((post) => ({
        params: { slug: post.slug },
    }));
}

const { slug } = Astro.params;

// Fetch full post content
const { data: post, error } = await supabase
    .from("blog_posts")
    .select("*")
    .eq("slug", slug)
    .single();

if (error || !post) {
    return Astro.redirect("/404");
}

// Fetch user session for interactions
const {
    data: { session },
} = await supabase.auth.getSession();
const user = session?.user || null;

// SEO Metadata
const title = `${post.title} | Cashless Thailand`;
const description = post.short_description;
const ogImage = post.image_url;
const tags = (post.tags || []) as string[];
const dynamicKeywords = [
    ...tags,
    "Bitcoin Thailand",
    "ข่าวบิตคอยน์",
    "ความรู้บิตคอยน์",
].join(", ");
---

<Layout
    title={title}
    description={description}
    image={ogImage}
    keywords={dynamicKeywords}
>
    <!-- Scroll Progress Bar -->
    <div
        id="scroll-progress"
        class="fixed top-0 left-0 h-[3px] bg-gradient-to-r from-[#D4AF37] to-white z-[100] transition-all duration-150 ease-out"
        style="width: 0%"
    >
    </div>

    <Navbar />

    <!-- Premium Animated Background -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div
            class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-[#D4AF37]/10 rounded-full blur-[150px] animate-blob"
        >
        </div>
        <div
            class="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-[#D4AF37]/5 rounded-full blur-[200px] animate-blob animation-delay-2000"
        >
        </div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-[radial-gradient(circle_at_center,rgba(212,175,55,0.03)_0%,transparent_70%)]"
        >
        </div>
    </div>

    <main
        class="relative z-10 pt-40 pb-32 px-4 md:px-8 max-w-6xl mx-auto"
        data-post-id={post.id}
    >
        <!-- Breadcrumbs with Entrance Animation -->
        <nav
            class="flex items-center gap-3 text-white/30 text-[10px] mb-12 font-black uppercase tracking-[0.3em] animate-fade-in-down"
        >
            <a
                href="/blog"
                class="hover:text-[#D4AF37] transition-all duration-300"
                >Insights</a
            >
            <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="4"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><polyline points="9 18 15 12 9 6"></polyline></svg
            >
            <span
                class="text-[#D4AF37] drop-shadow-[0_0_8px_rgba(212,175,55,0.4)]"
                >{post.category}</span
            >
        </nav>

        <!-- Signature Visual at Top -->
        {
            post.image_url && (
                <div class="mb-20 group relative animate-reveal shadow-2xl">
                    <div class="absolute -inset-10 bg-[#D4AF37]/20 blur-[100px] rounded-[5rem] opacity-30 group-hover:opacity-60 transition-opacity duration-1000" />
                    <div class="relative rounded-[3.5rem] overflow-hidden border border-white/10 aspect-[21/9] shadow-inner lg:scale-[1.02]">
                        <img
                            src={post.image_url}
                            alt={post.title}
                            class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105"
                        />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />
                    </div>
                </div>
            )
        }

        <!-- Article Header Section -->
        <header class="mb-20 space-y-10 animate-fade-in-up">
            <h1
                class="text-4xl md:text-7xl font-extrabold text-white leading-[1.2] tracking-tight max-w-5xl"
            >
                <span class="block overflow-hidden">
                    <span
                        class="block animate-slide-up bg-clip-text text-transparent bg-gradient-to-b from-white to-white/70"
                    >
                        {post.title}
                    </span>
                </span>
            </h1>

            <div
                class="grid grid-cols-1 sm:grid-cols-2 lg:flex lg:items-center gap-4 py-8 px-10 bg-white/[0.03] border border-white/5 rounded-[2.5rem] backdrop-blur-xl shadow-2xl relative overflow-hidden group"
            >
                <div
                    class="absolute inset-0 bg-gradient-to-r from-[#D4AF37]/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700"
                >
                </div>

                <!-- Author -->
                <div class="flex items-center gap-5 relative z-10">
                    <div
                        class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#D4AF37] to-[#996515] p-[2px] shadow-lg shadow-[#D4AF37]/20"
                    >
                        <div
                            class="w-full h-full rounded-[10px] bg-black flex items-center justify-center text-[#D4AF37] font-black text-[10px]"
                        >
                            CT
                        </div>
                    </div>
                    <div>
                        <p
                            class="text-white/40 text-[9px] font-black uppercase tracking-widest mb-1"
                        >
                            Author
                        </p>
                        <p class="text-white font-bold text-sm">แอดมิน</p>
                    </div>
                </div>

                <div class="h-8 w-px bg-white/10 mx-4 hidden lg:block"></div>

                <!-- Date -->
                <div class="flex items-center gap-5 relative z-10">
                    <div
                        class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-[#D4AF37] border border-white/5"
                    >
                        <svg
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            ><rect
                                x="3"
                                y="4"
                                width="18"
                                height="18"
                                rx="2"
                                ry="2"></rect><line
                                x1="16"
                                y1="2"
                                x2="16"
                                y2="6"></line><line x1="8" y1="2" x2="8" y2="6"
                            ></line><line x1="3" y1="10" x2="21" y2="10"
                            ></line></svg
                        >
                    </div>
                    <div>
                        <p
                            class="text-white/40 text-[9px] font-black uppercase tracking-widest mb-1"
                        >
                            Date
                        </p>
                        <p class="text-white font-bold text-sm">
                            {
                                new Date(post.created_at).toLocaleDateString(
                                    "th-TH",
                                    {
                                        day: "numeric",
                                        month: "short",
                                        year: "numeric",
                                    },
                                )
                            }
                        </p>
                    </div>
                </div>

                <div class="h-8 w-px bg-white/10 mx-4 hidden lg:block"></div>

                <!-- Time -->
                <div class="flex items-center gap-5 relative z-10">
                    <div
                        class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-[#D4AF37] border border-white/5"
                    >
                        <svg
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            ><circle cx="12" cy="12" r="10"></circle><polyline
                                points="12 6 12 12 16 14"></polyline></svg
                        >
                    </div>
                    <div>
                        <p
                            class="text-white/40 text-[9px] font-black uppercase tracking-widest mb-1"
                        >
                            Read
                        </p>
                        <p class="text-white font-bold text-sm">
                            {
                                Math.ceil(
                                    (post.content || "").split(" ").length /
                                        200,
                                )
                            } min
                        </p>
                    </div>
                </div>

                <div class="h-8 w-px bg-white/10 mx-4 hidden lg:block"></div>

                <!-- Views -->
                <div class="flex items-center gap-5 relative z-10">
                    <div
                        class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-[#D4AF37] border border-white/5"
                    >
                        <svg
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            ><path
                                d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                            ></path><circle cx="12" cy="12" r="3"></circle></svg
                        >
                    </div>
                    <div>
                        <p
                            class="text-white/40 text-[9px] font-black uppercase tracking-widest mb-1"
                        >
                            Views
                        </p>
                        <p class="text-white font-bold text-sm">
                            {post.view_count || 0}
                        </p>
                    </div>
                </div>

                <div class="h-8 w-px bg-white/10 ml-auto hidden lg:block"></div>

                <!-- Topic -->
                <div class="flex items-center gap-5 relative z-10 lg:ml-auto">
                    <div
                        class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center text-[#D4AF37] border border-[#D4AF37]/20 shadow-[0_0_15px_rgba(212,175,55,0.1)]"
                    >
                        <svg
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            ><path
                                d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"
                            ></path><line x1="7" y1="7" x2="7.01" y2="7"
                            ></line></svg
                        >
                    </div>
                    <div>
                        <p
                            class="text-white/40 text-[9px] font-black uppercase tracking-widest mb-1"
                        >
                            Topic
                        </p>
                        <p
                            class="text-[#D4AF37] font-black text-xs uppercase tracking-tight drop-shadow-[0_0_8px_rgba(212,175,55,0.4)]"
                        >
                            {post.category}
                        </p>
                    </div>
                </div>
            </div>
        </header>
    </main>

    <div class="max-w-3xl mx-auto space-y-24">
        <!-- Content Area with Enhanced Typography -->
        <article class="prose-container relative animate-fade-in-up delay-500">
            <div class="blog-content" set:html={post.content} />
        </article>

        <!-- Tags Section -->
        {
            tags.length > 0 && (
                <div class="flex flex-wrap gap-4 pt-12 border-t border-white/10">
                    {tags.map((tag) => (
                        <span class="px-6 py-3 bg-white/[0.02] hover:bg-[#D4AF37]/10 rounded-2xl text-[11px] font-black uppercase tracking-[0.15em] text-white/40 border border-white/5 hover:border-[#D4AF37]/30 hover:text-[#D4AF37] transition-all duration-300 cursor-default shadow-sm active:scale-95">
                            {tag}
                        </span>
                    ))}
                </div>
            )
        }

        <!-- Interactive Layer -->
        <div class="pt-24 border-t border-white/10 relative">
            <div
                class="absolute top-0 left-1/2 -translate-x-1/2 w-1/2 h-px bg-gradient-to-r from-transparent via-[#D4AF37]/50 to-transparent"
            >
            </div>
            <BlogInteractions client:load postId={post.id} user={user} />
        </div>

        <!-- Footer Action -->
        <div class="pt-12 text-center">
            <a
                href="/blog"
                class="inline-flex items-center gap-5 text-white/40 hover:text-white font-black uppercase tracking-[0.3em] text-[11px] transition-all duration-500 group py-6"
            >
                <div
                    class="w-12 h-12 rounded-full border border-white/10 flex items-center justify-center group-hover:border-[#D4AF37] group-hover:bg-[#D4AF37]/5 transition-all group-hover:rotate-12"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-4 h-4 transition-transform group-hover:-translate-x-1"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="4"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><line x1="19" y1="12" x2="5" y2="12"></line><polyline
                            points="12 19 5 12 12 5"></polyline></svg
                    >
                </div>
                Explore More Insights
            </a>
        </div>
    </div>

    <Footer />

    <script>
        const scrollProgress = document.getElementById("scroll-progress");
        const postId = (document.querySelector("[data-post-id]") as HTMLElement)
            ?.dataset.postId;

        // Increment View Count
        if (postId) {
            import("../../lib/supabase").then(({ supabase }) => {
                supabase
                    .rpc("increment_view_count", { post_id: postId })
                    .then(({ error }) => {
                        if (error)
                            console.error(
                                "Error incrementing view count:",
                                error,
                            );
                    });
            });
        }

        window.addEventListener("scroll", () => {
            const totalHeight =
                document.documentElement.scrollHeight - window.innerHeight;
            const progress = (window.pageYOffset / totalHeight) * 100;
            if (scrollProgress) {
                scrollProgress.style.width = `${progress}%`;
            }
        });
    </script>

    <style is:global>
        @keyframes blob {
            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(30px, -50px) scale(1.1);
            }
            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }
        }
        .animate-blob {
            animation: blob 10s infinite;
        }
        .animation-delay-2000 {
            animation-delay: 2s;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-down {
            animation: fadeInDown 1s cubic-bezier(0.23, 1, 0.32, 1) both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 1.2s cubic-bezier(0.23, 1, 0.32, 1) both;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        .animate-slide-up {
            animation: slideUp 1s cubic-bezier(0.23, 1, 0.32, 1) both;
        }

        @keyframes reveal {
            from {
                opacity: 0;
                transform: scale(0.95);
                filter: blur(10px);
            }
            to {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }
        }
        .animate-reveal {
            animation: reveal 1.5s cubic-bezier(0.23, 1, 0.32, 1) both;
        }

        .delay-500 {
            animation-delay: 0.5s;
        }

        /* Premium Typography & Article Styles */
        .blog-content {
            font-family: "Anuphan", "Inter", sans-serif;
            font-size: 1.25rem;
            line-height: 1.85;
            color: rgba(255, 255, 255, 0.85);
            letter-spacing: -0.01em;
        }

        .blog-content h1,
        .blog-content h2,
        .blog-content h3 {
            color: white;
            font-weight: 900;
            margin-top: 5rem;
            margin-bottom: 2rem;
            line-height: 1.1;
            letter-spacing: -0.04em;
        }

        .blog-content h2 {
            font-size: 3rem;
            background: gradient;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .blog-content h3 {
            font-size: 2.25rem;
        }

        .blog-content p {
            margin-bottom: 2.5rem;
            text-align: justify;
        }

        .blog-content blockquote {
            margin: 4rem 0;
            padding: 3rem;
            background: linear-gradient(
                135deg,
                rgba(212, 175, 55, 0.08) 0%,
                transparent 100%
            );
            border-left: 4px solid #d4af37;
            font-style: italic;
            color: #d4af37;
            font-size: 1.5rem;
            border-radius: 0 3rem 3rem 0;
            box-shadow: 20px 20px 60px rgba(0, 0, 0, 0.5);
        }

        .blog-content img {
            border-radius: 3rem;
            margin: 5rem -10%;
            width: 120%;
            max-width: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.5);
        }
        @media (max-width: 1024px) {
            .blog-content img {
                width: 100%;
                margin: 4rem 0;
            }
        }

        .blog-content a {
            color: #d4af37;
            font-weight: 800;
            position: relative;
            text-decoration: none;
        }
        .blog-content a::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #d4af37;
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .blog-content a:hover::after {
            transform: scaleX(1);
            transform-origin: left;
        }

        .blog-content ul,
        .blog-content ol {
            margin-bottom: 3rem;
            padding-left: 2rem;
        }
        .blog-content li {
            margin-bottom: 1rem;
            list-style: disc;
        }
        .blog-content li::marker {
            color: #d4af37;
        }
    </style>
</Layout>
