---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { supabase, supabaseAdmin } from "../../lib/supabase";

// 1. Fetch Referrals with Order and Profile details
const { data: referrals } = await supabaseAdmin
    .from("affiliate_referrals")
    .select(
        `
        *,
        referrer:profiles!referrer_id(id, first_name, last_name, email, avatar_url, tier),
        order:orders(id, customer_name, total_price, payment_status, created_at)
    `,
    )
    .order("created_at", { ascending: false });

const thbFormatter = new Intl.NumberFormat("th-TH", {
    style: "currency",
    currency: "THB",
});

// Calculate stats
const pendingAmount =
    referrals
        ?.filter((r) => r.status === "pending")
        .reduce((sum, r) => sum + Number(r.commission_amount), 0) || 0;
const approvedAmount =
    referrals
        ?.filter((r) => r.status === "approved")
        .reduce((sum, r) => sum + Number(r.commission_amount), 0) || 0;
const paidAmount =
    referrals
        ?.filter((r) => r.status === "paid")
        .reduce((sum, r) => sum + Number(r.commission_amount), 0) || 0;
---

<AdminLayout title="Affiliate Management">
    <div class="space-y-8">
        <div class="flex justify-between items-center">
            <div>
                <h1
                    class="text-3xl font-black text-white uppercase tracking-wider"
                >
                    Affiliate Referrals
                </h1>
                <p class="text-white/50 text-sm mt-1">
                    Manage partner commissions and payouts
                </p>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
                class="bg-[#0A0A0A] border border-yellow-500/20 p-6 rounded-2xl"
            >
                <p
                    class="text-white/50 text-xs font-bold uppercase tracking-widest mb-2"
                >
                    Pending Payouts
                </p>
                <p class="text-2xl font-black text-yellow-500">
                    {thbFormatter.format(pendingAmount)}
                </p>
            </div>
            <div
                class="bg-[#0A0A0A] border border-green-500/20 p-6 rounded-2xl"
            >
                <p
                    class="text-white/50 text-xs font-bold uppercase tracking-widest mb-2"
                >
                    Approved (Awaiting Payment)
                </p>
                <p class="text-2xl font-black text-green-500">
                    {thbFormatter.format(approvedAmount)}
                </p>
            </div>
            <div
                class="bg-[#0A0A0A] border border-white/10 p-6 rounded-2xl opacity-50"
            >
                <p
                    class="text-white/50 text-xs font-bold uppercase tracking-widest mb-2"
                >
                    Lifetime Paid
                </p>
                <p class="text-2xl font-black text-white">
                    {thbFormatter.format(paidAmount)}
                </p>
            </div>
        </div>

        <!-- Referrals Table -->
        <div
            class="bg-[#0A0A0A] border border-white/10 rounded-3xl overflow-hidden shadow-2xl"
        >
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr
                            class="bg-white/5 text-[10px] text-white/40 uppercase tracking-[0.2em] font-black"
                        >
                            <th class="px-6 py-4">Affiliate / Referrer</th>
                            <th class="px-6 py-4">Order Details</th>
                            <th class="px-6 py-4">Commission</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {
                            referrals?.map((ref) => (
                                <tr class="hover:bg-white/2 transition-colors group">
                                    <td class="px-6 py-6">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-black border border-white/10 overflow-hidden shrink-0">
                                                <img
                                                    src={
                                                        ref.referrer
                                                            ?.avatar_url ||
                                                        `https://unavatar.io/${ref.referrer?.email}?fallback=https://source.boringavatars.com/marble/120/${encodeURIComponent(ref.referrer?.first_name || "U")}`
                                                    }
                                                    class="w-full h-full object-cover"
                                                />
                                            </div>
                                            <div>
                                                <p class="text-white font-bold">
                                                    {ref.referrer?.first_name}{" "}
                                                    {ref.referrer?.last_name}
                                                </p>
                                                <p class="text-[10px] text-white/40 font-mono">
                                                    {ref.referrer?.email}
                                                </p>
                                                <span class="inline-block mt-1 px-2 py-0.5 rounded-full text-[8px] font-black uppercase tracking-widest bg-[#D4AF37]/10 text-[#D4AF37] border border-[#D4AF37]/20">
                                                    {ref.referrer?.tier}
                                                </span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-6">
                                        <p class="text-white text-sm font-bold">
                                            Order #
                                            {ref.referred_order_id?.slice(0, 8)}
                                        </p>
                                        <p class="text-white/40 text-xs">
                                            {ref.order?.customer_name}
                                        </p>
                                        <p class="text-[10px] text-white/20 mt-1">
                                            {new Date(
                                                ref.created_at,
                                            ).toLocaleString("th-TH")}
                                        </p>
                                    </td>
                                    <td class="px-6 py-6 font-black text-white">
                                        <span class="text-[#D4AF37]">
                                            {thbFormatter.format(
                                                ref.commission_amount,
                                            )}
                                        </span>
                                        <p class="text-[9px] text-white/20 font-normal">
                                            from{" "}
                                            {thbFormatter.format(
                                                ref.order?.total_price,
                                            )}
                                        </p>
                                    </td>
                                    <td class="px-6 py-6">
                                        <span
                                            class={`px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-[0.1em] ${
                                                ref.status === "paid"
                                                    ? "bg-white/10 text-white opacity-50"
                                                    : ref.status === "approved"
                                                      ? "bg-green-500/10 text-green-500 border border-green-500/20"
                                                      : ref.status === "pending"
                                                        ? "bg-yellow-500/10 text-yellow-500 border border-yellow-500/20"
                                                        : "bg-red-500/10 text-red-500"
                                            }`}
                                        >
                                            {ref.status}
                                        </span>
                                    </td>
                                    <td class="px-6 py-6 text-right">
                                        <div class="flex justify-end gap-2">
                                            {ref.status === "pending" && (
                                                <button
                                                    class="px-3 py-1.5 bg-green-600/20 text-green-500 hover:bg-green-600 hover:text-white rounded-lg text-[10px] font-black uppercase transition-all border border-green-600/30"
                                                    onclick={`updateReferralStatus('${ref.id}', 'approved')`}
                                                >
                                                    Approve
                                                </button>
                                            )}
                                            {ref.status === "approved" && (
                                                <button
                                                    class="px-3 py-1.5 bg-[#D4AF37] text-black hover:bg-white rounded-lg text-[10px] font-black uppercase transition-all shadow-lg shadow-[#D4AF37]/10"
                                                    onclick={`updateReferralStatus('${ref.id}', 'paid')`}
                                                >
                                                    Mark as Paid
                                                </button>
                                            )}
                                            <button
                                                class="p-1.5 text-white/20 hover:text-red-500 transition-colors"
                                                onclick={`updateReferralStatus('${ref.id}', 'rejected')`}
                                                title="Reject"
                                            >
                                                <svg
                                                    class="w-4 h-4"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M6 18L18 6M6 6l12 12"
                                                    />
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        }
                        {
                            !referrals?.length && (
                                <tr>
                                    <td
                                        colspan="5"
                                        class="px-6 py-20 text-center text-white/20 italic"
                                    >
                                        No referrals found.
                                    </td>
                                </tr>
                            )
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</AdminLayout>

<script>
    import { supabase } from "../../lib/supabase";

    declare global {
        interface Window {
            updateReferralStatus: (
                id: string,
                newStatus: string,
            ) => Promise<void>;
        }
    }

    window.updateReferralStatus = async (id, newStatus) => {
        const confirmMsg =
            newStatus === "paid"
                ? "Have you transferred the money to the affiliate? Confirm marking as PAID."
                : `Are you sure you want to change status to ${newStatus.toUpperCase()}?`;

        if (!confirm(confirmMsg)) return;

        const { error } = await supabase
            .from("affiliate_referrals")
            .update({ status: newStatus })
            .eq("id", id);

        if (error) {
            alert("Error: " + error.message);
        } else {
            location.reload();
        }
    };
</script>
