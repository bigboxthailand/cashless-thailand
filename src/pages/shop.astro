---
// src/pages/shop.astro
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import CartDrawer from "../components/CartDrawer.astro";
import { supabase } from "../lib/supabase";

// Fetch products from Supabase
let allProducts = [];
const { data, error } = await supabase
    .from("products")
    .select("*")
    .order("created_at", { ascending: false });

if (error) {
    console.error("Error fetching products:", error);
} else {
    allProducts = data || [];

    // Explicit reorder: CryptoClock Basic should come before CryptoClockSaving
    const basicIndex = allProducts.findIndex(
        (p) =>
            p.meta?.title === "CryptoClock Basic" ||
            p.id === "cryptoclock-basic",
    );
    const savingIndex = allProducts.findIndex(
        (p) =>
            p.meta?.title === "CryptoClock Saving" ||
            p.id === "cryptoclock-saving",
    );

    if (basicIndex !== -1 && savingIndex !== -1 && basicIndex > savingIndex) {
        // Swap them if Basic is currently after Saving
        const temp = allProducts[basicIndex];
        allProducts.splice(basicIndex, 1);
        allProducts.splice(savingIndex, 0, temp);
    }
}

// 2. Define Category Metadata (Pretty names & descriptions)
const categoryMeta: any = {
    clock: {
        title: "CryptoClock Series",
        desc: "นาฬิกาคริปโตสำหรับทุกไลฟ์สไตล์",
    },
    kiosk: {
        title: "BiTTerm Solutions",
        desc: "ตู้แลกเหรียญและเติมเงินอัตโนมัติ",
    },
    pos: {
        title: "Point of Sale (POS)",
        desc: "ระบบรับชำระเงินสำหรับร้านค้ายุคใหม่",
    },
    node: {
        title: "Infrastructure",
        desc: "อุปกรณ์รันโหนดเพื่อความเป็นส่วนตัว",
    },
    shirt: { title: "Bitcoin WEAR", desc: "เสื้อคริปโตสำหรับสาย Hodl" },
    keychain: { title: "Crypto Keychains", desc: "พวงกุญแจของสะสม" },
    mug: { title: "Holder Mugs", desc: "แก้วน้ำชาวดอย" },
};

// 3. Extract Unique Categories from Products
const uniqueCategorySlugs = [
    ...new Set(
        allProducts.map((p) =>
            (p.category || p.config?.category || "other").toLowerCase(),
        ),
    ),
];

// 4. Map to Category Objects
const categories = uniqueCategorySlugs
    .map((slug) => ({
        id: slug,
        title:
            categoryMeta[slug]?.title ||
            slug.charAt(0).toUpperCase() + slug.slice(1),
        desc: categoryMeta[slug]?.desc || "Explore our collection",
    }))
    .sort((a, b) => {
        // Sort logic: Keep original order for known categories, others at the end
        const order = [
            "clock",
            "kiosk",
            "pos",
            "node",
            "shirt",
            "keychain",
            "mug",
        ];
        const idxA = order.indexOf(a.id);
        const idxB = order.indexOf(b.id);
        if (idxA === -1 && idxB === -1) return a.id.localeCompare(b.id);
        if (idxA === -1) return 1;
        if (idxB === -1) return -1;
        return idxA - idxB;
    });
---

<Layout title="Shop | Cashless Thailand">
    <Navbar />
    <CartDrawer />

    <main class="bg-[#050505] min-h-screen pb-32">
        <div class="relative pt-40 pb-20 px-6 text-center overflow-hidden">
            <div
                class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-[500px] bg-[#D4AF37]/10 rounded-full blur-[120px] pointer-events-none"
            >
            </div>

            <h1
                class="text-6xl md:text-8xl font-[900] text-white uppercase tracking-tighter mb-6 relative z-10 animate-fade-in-up"
            >
                Store <span
                    class="text-transparent bg-clip-text bg-gradient-to-r from-[#D4AF37] via-[#F4E08F] to-[#D4AF37]"
                    >Catalog</span
                >
            </h1>
            <p
                class="text-white/60 font-light text-lg max-w-2xl mx-auto relative z-10 animate-fade-in-up delay-100"
            >
                นวัตกรรม Bitcoin Hardware ฝีมือคนไทย
                ที่ผสมผสานเทคโนโลยีเข้ากับไลฟ์สไตล์ของคุณ
            </p>
        </div>

        <div class="max-w-[1400px] mx-auto px-6 md:px-12 space-y-32">
            {
                categories.map((cat, index) => {
                    // กรองสินค้าตามหมวดหมู่ (Flexible matching: Handle lowercase/uppercase and config object)
                    const categoryProducts = allProducts.filter((p) => {
                        // Support both direct 'category' column and 'config.category' JSON path
                        const productCategory =
                            p.category || p.config?.category || "";
                        return (
                            productCategory.toLowerCase() ===
                            cat.id.toLowerCase()
                        );
                    });

                    if (categoryProducts.length === 0) return null;

                    return (
                        <section id={cat.id} class="scroll-mt-32">
                            <div class="flex items-center gap-6 mb-12 group cursor-default">
                                <div class="h-[1px] flex-1 bg-gradient-to-r from-transparent to-[#D4AF37]/50" />
                                <h2 class="text-3xl md:text-4xl font-[900] text-white uppercase tracking-tight text-center">
                                    <span class="text-[#D4AF37] block text-sm tracking-[0.3em] mb-2 font-medium">
                                        0{index + 1} Collection
                                    </span>
                                    {cat.title}
                                </h2>
                                <div class="h-[1px] flex-1 bg-gradient-to-l from-transparent to-[#D4AF37]/50" />
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                                {categoryProducts.map((rawItem, i) => {
                                    // Parse JSON fields if they are strings (Supabase sometimes returns JSONB as string if not typed)
                                    // @ts-ignore
                                    const parse = (val) =>
                                        typeof val === "string"
                                            ? JSON.parse(val)
                                            : val;

                                    const item = {
                                        ...rawItem,
                                        meta: parse(rawItem.meta) || {},
                                        pricing: parse(rawItem.pricing) || {},
                                        config: parse(rawItem.config) || {},
                                        media: parse(rawItem.media) || {},
                                    };

                                    let displayPrice = 0;
                                    let comparePrice = 0;
                                    const hasVariants =
                                        item.config.variants &&
                                        item.config.variants.length > 0;

                                    if (hasVariants) {
                                        // Priority: ONLY use prices from variants if they exist
                                        item.config.variants.forEach(
                                            (v: any) => {
                                                const vPrice =
                                                    typeof v.price === "string"
                                                        ? parseFloat(v.price)
                                                        : v.price;
                                                const vCompare = v.comparePrice
                                                    ? typeof v.comparePrice ===
                                                      "string"
                                                        ? parseFloat(
                                                              v.comparePrice,
                                                          )
                                                        : v.comparePrice
                                                    : 0;

                                                if (
                                                    vPrice > 0 &&
                                                    (displayPrice === 0 ||
                                                        vPrice < displayPrice)
                                                ) {
                                                    displayPrice = vPrice;
                                                }
                                                if (
                                                    vCompare > 0 &&
                                                    vCompare > comparePrice
                                                ) {
                                                    comparePrice = vCompare;
                                                }
                                            },
                                        );
                                    } else {
                                        // Product Level pricing
                                        displayPrice =
                                            item.pricing.basePrice || 0;
                                        comparePrice =
                                            item.pricing.comparePrice || 0;
                                    }

                                    const discount =
                                        comparePrice > displayPrice &&
                                        comparePrice > 0
                                            ? Math.round(
                                                  ((comparePrice -
                                                      displayPrice) /
                                                      comparePrice) *
                                                      100,
                                              )
                                            : 0;

                                    const finalComparePrice =
                                        comparePrice > displayPrice
                                            ? comparePrice
                                            : 0;

                                    const totalStock = hasVariants
                                        ? item.config.variants.reduce(
                                              (acc: number, v: any) =>
                                                  acc +
                                                  (parseInt(v.stock) || 0),
                                              0,
                                          )
                                        : parseInt(
                                              item.config?.inventory?.stock ||
                                                  item.stock ||
                                                  0,
                                          );

                                    return (
                                        <a
                                            href={`/products/${item.id}`}
                                            class="group relative block bg-[#111] rounded-[20px] overflow-hidden border border-white/5 hover:border-[#D4AF37]/50 transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_10px_40px_-10px_rgba(212,175,55,0.2)] product-card-anim"
                                            style={`animation-delay: ${i * 100}ms`}
                                        >
                                            <div class="aspect-[4/5] relative overflow-hidden bg-[#0a0a0a]">
                                                <img
                                                    src={item.media.mainImage}
                                                    alt={item.meta.title}
                                                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                                    loading="lazy"
                                                    onerror="this.src='https://placehold.co/600x800/1a1a1a/FFF?text=No+Image'"
                                                />

                                                {/* Out of Stock Overlay */}
                                                {totalStock <= 0 && (
                                                    <div class="absolute inset-0 z-20 flex items-center justify-center bg-black/40 backdrop-blur-[2px]">
                                                        <div class="px-6 py-3 bg-white/10 border border-white/20 backdrop-blur-xl rounded-2xl shadow-xl transform -rotate-12">
                                                            <span class="text-xl font-black text-white/40 uppercase tracking-widest">
                                                                SOLD OUT
                                                            </span>
                                                        </div>
                                                    </div>
                                                )}

                                                <div class="absolute inset-0 bg-gradient-to-t from-[#050505] via-transparent to-transparent opacity-60" />

                                                {/* ดึง Tag ตัวแรกจาก Array มาแสดง */}
                                                {item.meta.tags &&
                                                    item.meta.tags.length >
                                                        0 && (
                                                        <div class="absolute top-3 left-3 px-3 py-1 bg-[#D4AF37] text-black text-[10px] font-black uppercase tracking-widest rounded-full shadow-lg z-10">
                                                            {item.meta.tags[0]}
                                                        </div>
                                                    )}

                                                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-black/20 backdrop-blur-[2px]">
                                                    <span class="px-6 py-3 bg-white text-black font-bold uppercase tracking-wider rounded-full transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 shadow-xl hover:bg-[#D4AF37] hover:scale-105">
                                                        View Details
                                                    </span>
                                                </div>

                                                {discount > 0 && (
                                                    <div class="absolute top-0 right-0 w-24 h-24 overflow-hidden pointer-events-none z-30">
                                                        <div class="absolute top-4 -right-8 w-32 bg-gradient-to-r from-[#ff0000] to-[#cc0000] text-white text-[10px] font-black tracking-widest uppercase py-1 text-center rotate-45 shadow-[0_4px_10px_rgba(255,0,0,0.4)] border-y border-white/20">
                                                            SALE -{discount}%
                                                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full animate-[shimmer-simple_3s_infinite]" />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            <div class="p-6 relative bg-[#111]">
                                                <div class="absolute -top-10 left-0 w-full h-10 bg-gradient-to-t from-[#111] to-transparent" />

                                                <h3 class="text-lg font-bold text-white mb-1 group-hover:text-[#D4AF37] transition-colors line-clamp-1">
                                                    {item.meta.title}
                                                </h3>
                                                <p class="text-xs text-white/40 mb-4 font-light line-clamp-1">
                                                    {item.meta.description}
                                                </p>

                                                <div class="flex items-center justify-between pt-4 border-t border-white/5">
                                                    <div class="flex flex-col">
                                                        <span class="text-[10px] text-white/40 uppercase tracking-widest">
                                                            Starts at
                                                        </span>
                                                        <div class="flex items-baseline gap-2">
                                                            <span class="text-xl font-black text-[#D4AF37] eng">
                                                                {displayPrice.toLocaleString()}{" "}
                                                                <span class="text-xs font-medium text-white/50">
                                                                    {item
                                                                        .pricing
                                                                        .currency ||
                                                                        "THB"}
                                                                </span>
                                                            </span>
                                                            {finalComparePrice >
                                                                displayPrice && (
                                                                <span class="text-xs text-white/30 line-through decoration-[#D4AF37]/40">
                                                                    {finalComparePrice.toLocaleString()}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-[#D4AF37] group-hover:text-black transition-colors">
                                                        <svg
                                                            xmlns="http://www.w3.org/2000/svg"
                                                            width="16"
                                                            height="16"
                                                            viewBox="0 0 24 24"
                                                            fill="none"
                                                            stroke="currentColor"
                                                            stroke-width="2"
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                        >
                                                            <path d="m9 18 6-6-6-6" />
                                                        </svg>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    );
                                })}
                            </div>
                        </section>
                    );
                })
            }
        </div>
    </main>
    <Footer />
</Layout>

<style>
    /* ... Style เดิมที่คุณมีอยู่ ... */
    .animate-fade-in-up {
        animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        opacity: 0;
        transform: translateY(20px);
    }

    .delay-100 {
        animation-delay: 0.1s;
    }

    .product-card-anim {
        animation: cardReveal 0.6s ease-out forwards;
        opacity: 0;
        transform: translateY(30px);
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes cardReveal {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    @keyframes shimmer {
        0% {
            transform: translateX(-100%) rotate(45deg);
        }
        100% {
            transform: translateX(200%) rotate(45deg);
        }
    }

    .shimmer-effect {
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer-simple {
        100% {
            transform: translateX(200%);
        }
    }
</style>
