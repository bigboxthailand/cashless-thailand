---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import CartDrawer from '../components/CartDrawer.astro';
import ProductCard from '../components/ProductCard.astro';

// Mock Data (เพิ่ม field 'brand' เข้าไป)
const allProducts = [
  {
    id: "trezor-safe-3-gold",
    title: "Trezor Safe 3 (Bitcoin Only) - Gold Edition",
    category: "hardware",
    brand: "trezor", // เพิ่ม Brand
    price: 7500,
    image: "https://images.unsplash.com/photo-1621416894569-0f39ed31d247?auto=format&fit=crop&q=80&w=800",
    hoverImage: "https://images.unsplash.com/photo-1642104704074-907c0698cbd9?auto=format&fit=crop&q=80&w=800",
    tag: "LIMITED"
  },
  {
    id: "onekey-classic-1s",
    title: "OneKey Classic 1S (EAL6+)",
    category: "hardware",
    brand: "onekey",
    price: 3790,
    image: "https://images.unsplash.com/photo-1639762681485-074b7f938ba0?auto=format&fit=crop&q=80&w=800",
    tag: "BEST SELLER"
  },
  {
    id: "blockstream-jade",
    title: "Blockstream Jade - Transparent",
    category: "hardware",
    brand: "blockstream",
    price: 2490,
    image: "https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&q=80&w=800",
    tag: "AIR-GAPPED"
  },
  {
    id: "bitcast-cardnest",
    title: "Bitcast Cardnest - Leather Case",
    category: "accessory",
    brand: "bitcast",
    price: 395,
    image: "https://images.unsplash.com/photo-1628191013620-3023246eb767?auto=format&fit=crop&q=80&w=800",
    tag: "NEW"
  },
  {
    id: "metal-seed-plate",
    title: "Trezor Keep Metal - 24 Words",
    category: "backup",
    brand: "trezor",
    price: 4550,
    image: "https://images.unsplash.com/photo-1536566482680-fca31930a0bd?auto=format&fit=crop&q=80&w=800",
    tag: "ESSENTIAL"
  },
  {
    id: "bitcoin-course",
    title: "Bitcoin Mastery Course 2026",
    category: "course",
    brand: "bitcast",
    price: 4900,
    image: "https://images.unsplash.com/photo-1640340434855-6084b1f4901c?auto=format&fit=crop&q=80&w=800",
    tag: "POPULAR"
  }
];
---

<Layout title="The Armory | Shop - Cashless Thailand">
    <Navbar />
    <CartDrawer />

    <main class="relative z-10 bg-[#050505] min-h-screen pt-28 pb-20">
        
        <div class="max-w-[1800px] mx-auto px-6 md:px-12 mb-10">
            <nav class="flex items-center gap-2 text-[10px] uppercase tracking-widest text-white/40 mb-6">
                <a href="/" class="hover:text-[#D4AF37]">Home</a>
                <span>/</span>
                <span class="text-[#D4AF37]">Shop</span>
            </nav>

            <div class="flex flex-col md:flex-row justify-between items-end gap-6 border-b border-white/10 pb-8">
                <h1 class="text-4xl md:text-6xl font-black text-white uppercase tracking-tighter">
                    Digital <span class="text-[#D4AF37]">Armory</span>
                </h1>
                
                <div id="active-filter-label" class="hidden px-4 py-2 bg-[#D4AF37]/10 border border-[#D4AF37] rounded-lg text-[#D4AF37] text-xs font-bold uppercase tracking-widest">
                    Showing: <span id="filter-name">All</span>
                </div>
            </div>
        </div>

        <div class="max-w-[1800px] mx-auto px-6 md:px-12 flex gap-12 relative">
            
            <aside id="filter-sidebar" class="hidden lg:block w-64 shrink-0 space-y-8 sticky top-32 h-fit">
                <div class="space-y-4">
                    <h3 class="text-sm font-bold text-white uppercase tracking-widest">Category</h3>
                    <div class="flex flex-col gap-2">
                        <button class="filter-btn text-left text-white/60 hover:text-white text-sm transition-colors active" data-type="category" data-val="all">All Products</button>
                        <button class="filter-btn text-left text-white/60 hover:text-white text-sm transition-colors" data-type="category" data-val="hardware">Hardware Wallets</button>
                        <button class="filter-btn text-left text-white/60 hover:text-white text-sm transition-colors" data-type="category" data-val="backup">Backup</button>
                        <button class="filter-btn text-left text-white/60 hover:text-white text-sm transition-colors" data-type="category" data-val="accessory">Accessories</button>
                        <button class="filter-btn text-left text-white/60 hover:text-white text-sm transition-colors" data-type="category" data-val="course">Courses</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-sm font-bold text-white uppercase tracking-widest">Brand</h3>
                    <div class="flex flex-col gap-2">
                        {['Trezor', 'OneKey', 'Blockstream', 'Foundation', 'Bitcast'].map(b => (
                            <button class="filter-btn text-left text-white/60 hover:text-white text-sm transition-colors" data-type="brand" data-val={b.toLowerCase()}>{b}</button>
                        ))}
                    </div>
                </div>
            </aside>

            <div class="flex-1">
                <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-6 gap-y-10">
                    {allProducts.map((product) => (
                        <div class="product-item" data-category={product.category} data-brand={product.brand}>
                             <ProductCard {...product} />
                        </div>
                    ))}
                </div>
                <div id="empty-state" class="hidden py-32 text-center w-full">
                    <p class="text-white/30 text-lg uppercase tracking-widest">No products found</p>
                    <a href="/shop" class="text-[#D4AF37] underline mt-2 inline-block">Clear Filters</a>
                </div>
            </div>

        </div>
    </main>
    
    <Footer />
</Layout>

<script>
    document.addEventListener('astro:page-load', () => {
        const items = document.querySelectorAll('.product-item');
        const btns = document.querySelectorAll('.filter-btn');
        const filterName = document.getElementById('filter-name');
        const activeLabel = document.getElementById('active-filter-label');
        const emptyState = document.getElementById('empty-state');

        // ฟังก์ชันกรองสินค้า
        function filter(type, value) {
            let count = 0;
            items.forEach(item => {
                const itemCat = item.getAttribute('data-category');
                const itemBrand = item.getAttribute('data-brand');
                
                let match = false;
                if (value === 'all') match = true;
                else if (type === 'category' && itemCat === value) match = true;
                else if (type === 'brand' && itemBrand === value) match = true;

                if (match) {
                    item.style.display = 'block';
                    count++;
                } else {
                    item.style.display = 'none';
                }
            });

            // อัปเดต UI
            if(filterName) filterName.innerText = value.charAt(0).toUpperCase() + value.slice(1);
            if(activeLabel) activeLabel.classList.remove('hidden');
            if(emptyState) emptyState.style.display = count === 0 ? 'block' : 'none';

            // อัปเดตปุ่ม Active
            btns.forEach(btn => {
                btn.classList.remove('text-[#D4AF37]', 'font-bold');
                btn.classList.add('text-white/60');
                if(btn.getAttribute('data-val') === value) {
                    btn.classList.add('text-[#D4AF37]', 'font-bold');
                    btn.classList.remove('text-white/60');
                }
            });
        }

        // 1. ตรวจสอบ URL Query Param เมื่อโหลดหน้า (เช่น ?brand=trezor)
        const params = new URLSearchParams(window.location.search);
        const brandParam = params.get('brand');
        const catParam = params.get('category');

        if (brandParam) filter('brand', brandParam);
        else if (catParam) filter('category', catParam);
        else filter('category', 'all');

        // 2. คลิกปุ่ม Filter ใน Sidebar
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.getAttribute('data-type');
                const val = btn.getAttribute('data-val');
                
                // อัปเดต URL โดยไม่รีเฟรชหน้า (เปลี่ยน URL ให้สวย)
                const newUrl = new URL(window.location);
                newUrl.searchParams.delete('brand');
                newUrl.searchParams.delete('category');
                if (val !== 'all') newUrl.searchParams.set(type, val);
                window.history.pushState({}, '', newUrl);

                filter(type, val);
            });
        });
    });
</script>