---
// src/pages/knowledge/[id].astro
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";
import productsData from "../../data/products.json";
import manualsData from "../../data/manuals.json";

export async function getStaticPaths() {
    return productsData.map((product) => ({
        params: { id: product.id },
        props: { product },
    }));
}

const { id } = Astro.params;
// ในโหมด SSR (output: 'server') getStaticPaths จะไม่ถูกเรียกตอน Runtime ทำให้ไม่มี props ส่งมา
// เราจึงต้องหา product จาก id แทน หรือใช้ props ถ้ามี (กรณี SSG)
const product = Astro.props.product || productsData.find((p) => p.id === id);

if (!product) {
    return Astro.redirect("/404");
}

// ดึงข้อมูล Manual
const manual = manualsData[product.id] || {
    title: "Coming Soon",
    intro: "ข้อมูลคู่มือสำหรับสินค้ารุ่นนี้กำลังอยู่ในระหว่างการจัดทำ",
    sections: [],
};

// --- THEME CONFIGURATION (ตั้งค่าสีตามรุ่น) ---
const defaultTheme = {
    bgMain: "bg-[#050505]", // พื้นหลังหลัก
    bgGradient: "", // แสง Gradient ด้านบน (ถ้ามี)
    textMain: "text-white", // สีตัวอักษรหลัก
    textSub: "text-white/60", // สีตัวอักษรรอง
    accent: "text-[#D4AF37]", // สีเน้น (หัวข้อ/ลิ้งค์)
    accentBg: "bg-[#D4AF37]", // สีพื้นหลังของปุ่ม/Icon
    cardBg: "bg-[#111]", // สีพื้นหลังของการ์ด
    cardBorder: "border-white/10", // สีขอบการ์ด
    stepBadge: "bg-[#D4AF37]/10 text-[#D4AF37]", // สีป้าย Step
};

const themeSettings = {
    // 1. CryptoClock Basic: สีเทอร์ควอยซ์ (Turquoise/Teal)
    "cryptoclock-basic": {
        ...defaultTheme,
        bgMain: "bg-slate-950",
        bgGradient:
            "bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-teal-900/30 via-slate-950 to-slate-950",
        accent: "text-teal-400",
        accentBg: "bg-teal-500",
        stepBadge: "bg-teal-500/10 text-teal-400",
    },
    // 2. CryptoClock Pro: สีเขียวเข้ม (Dark Green/Emerald)
    "cryptoclock-pro": {
        ...defaultTheme,
        bgMain: "bg-black",
        bgGradient:
            "bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-green-900/40 via-black to-black",
        accent: "text-emerald-400",
        accentBg: "bg-emerald-500",
        stepBadge: "bg-emerald-500/10 text-emerald-400",
    },
    // 3. CryptoClock ePaper: สีขาว/หินอ่อน (White/Marble - Light Theme)
    "cryptoclock-epaper": {
        ...defaultTheme,
        bgMain: "bg-[#f8f9fa]", // พื้นหลังสว่าง
        bgGradient:
            "bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] from-gray-200 via-[#f8f9fa] to-[#f8f9fa]",
        textMain: "text-slate-900", // เปลี่ยนตัวอักษรเป็นสีเข้ม
        textSub: "text-slate-600",
        accent: "text-slate-800",
        accentBg: "bg-slate-800",
        cardBg: "bg-white", // การ์ดสีขาว
        cardBorder: "border-gray-200 shadow-sm", // ขอบสีเทาอ่อน + เงา
        stepBadge: "bg-slate-200 text-slate-800",
    },
    // 4. CryptoClock Saving: สีส้ม Cyberpunk
    "cryptoclock-saving": {
        ...defaultTheme,
        bgMain: "bg-black",
        bgGradient:
            "bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-orange-600/20 via-black to-black",
        accent: "text-orange-500",
        accentBg: "bg-orange-600",
        stepBadge: "bg-orange-500/10 text-orange-500",
    },
    // 5. BiTTerm Series: สีส้ม Bitcoin Industrial
    "bitterm-series": {
        ...defaultTheme,
        bgMain: "bg-[#0b0b0b]",
        bgGradient:
            "bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-amber-700/20 via-[#0b0b0b] to-[#0b0b0b]",
        accent: "text-amber-500",
        accentBg: "bg-amber-600",
        stepBadge: "bg-amber-500/10 text-amber-500",
    },
    // 6. BiTPos Terminal: สีแดง (Red/Restaurant)
    "bitpos-terminal": {
        ...defaultTheme,
        bgMain: "bg-[#0f0505]",
        bgGradient:
            "bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-red-900/30 via-[#0f0505] to-[#0f0505]",
        accent: "text-red-500",
        accentBg: "bg-red-600",
        stepBadge: "bg-red-500/10 text-red-500",
    },
    // 7. BiTNode Personal: สีส้ม+ม่วง (Lightning Network)
    "bitnode-personal": {
        ...defaultTheme,
        bgMain: "bg-[#080510]", // พื้นหลังอมม่วงดำ
        bgGradient:
            "bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-purple-900/30 via-orange-900/10 to-[#080510]",
        accent: "text-purple-400",
        accentBg: "bg-purple-500",
        stepBadge: "bg-purple-500/10 text-purple-400",
    },
};

// เลือกธีมตาม Product ID ถ้าไม่มีให้ใช้ Default
const theme = themeSettings[product.id] || defaultTheme;

// ฟังก์ชันแยกแยะ YouTube ID
const getYouTubeID = (url) => {
    if (!url) return null;
    const regExp =
        /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return match && match[2].length === 11 ? match[2] : null;
};
---

<Layout title={`Manual: ${product.meta.title}`}>
    <Navbar />

    {/* ใช้ theme.bgMain และ theme.bgGradient แทนค่า Fix */}
    <main
        class={`${theme.bgMain} ${theme.bgGradient} min-h-screen pt-28 pb-20 scroll-smooth`}
    >
        {/* --- Hero Section --- */}
        {
            /* ใช้ theme.cardBorder แทน border-white/10 เพื่อให้เข้ากับ ePaper ที่เป็น Light Theme */
        }
        <div class={`relative border-b ${theme.cardBorder} bg-transparent`}>
            <div class="max-w-7xl mx-auto px-6 py-16">
                <a
                    href={`/products/${product.id}`}
                    class={`inline-flex items-center gap-2 ${theme.accent} text-sm font-bold uppercase tracking-widest mb-6 hover:opacity-80 transition-opacity`}
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
                    >
                    Back to Product
                </a>
                <h1
                    class={`text-4xl md:text-6xl font-black ${theme.textMain} mb-6 leading-tight`}
                >
                    {manual.title}
                    <span
                        class={`block ${theme.accent} text-2xl md:text-4xl mt-2 font-bold`}
                        >{product.meta.title}</span
                    >
                </h1>
                <p class={`${theme.textSub} text-xl max-w-3xl leading-relaxed`}>
                    {manual.intro}
                </p>
            </div>
        </div>

        <div
            class="max-w-7xl mx-auto px-6 py-12 flex flex-col lg:flex-row gap-12"
        >
            {/* --- Sticky Table of Contents (Desktop Only) --- */}
            <aside class="hidden lg:block w-64 shrink-0">
                <div
                    class={`sticky top-32 ${theme.cardBg} border ${theme.cardBorder} rounded-2xl p-6`}
                >
                    <h3
                        class={`${theme.textMain} font-bold mb-4 uppercase tracking-wider text-sm border-b ${theme.cardBorder} pb-2`}
                    >
                        Contents
                    </h3>
                    <ul class="space-y-1 text-sm">
                        {
                            manual.sections.map((section) => (
                                <li>
                                    <a
                                        href={`#${section.id}`}
                                        class={`${theme.textSub} hover:${theme.accent} transition-all block py-2 px-3 rounded-lg -ml-3`}
                                    >
                                        {section.title}
                                    </a>
                                </li>
                            ))
                        }
                    </ul>
                </div>
            </aside>

            {/* --- Main Content Area --- */}
            <div class="flex-1 space-y-20">
                {
                    manual.sections.map((section, idx) => (
                        <section id={section.id} class="scroll-mt-32">
                            {/* Section Header */}
                            <div
                                class={`mb-8 border-l-4 ${theme.cardBorder.replace("border", "border-l-4").replace("white/10", theme.accent.replace("text-", "border-"))} pl-6`}
                                style={`border-color: currentColor; color: ${theme.accentBg.replace("bg-", "")}`}
                            >
                                {/* ^ Hack เล็กน้อยเพื่อให้ border color ตาม accent color แบบ dynamic */}
                                <h2
                                    class={`text-3xl font-bold ${theme.textMain} mb-2`}
                                >
                                    {section.title}
                                </h2>
                                {section.intro && (
                                    <p class={theme.textSub}>{section.intro}</p>
                                )}
                            </div>

                            {/* --- CONTENT SWITCHER BASED ON TYPE --- */}

                            {/* 1. TYPE: FEATURES (List) */}
                            {section.type === "features" && (
                                <ul class="grid md:grid-cols-2 gap-4">
                                    {section.items.map((item) => (
                                        <li
                                            class={`flex items-start gap-3 ${theme.cardBg} p-4 rounded-xl border ${theme.cardBorder} hover:opacity-90 transition-opacity`}
                                        >
                                            <svg
                                                class={`w-6 h-6 ${theme.accent} shrink-0`}
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M5 13l4 4L19 7"
                                                />
                                            </svg>
                                            <span class={`${theme.textSub}`}>
                                                {item}
                                            </span>
                                        </li>
                                    ))}
                                </ul>
                            )}

                            {/* 2. TYPE: GRID_CARD */}
                            {section.type === "grid_card" && (
                                <div class="grid md:grid-cols-2 gap-6">
                                    {section.items.map((item) => (
                                        <div
                                            class={`${theme.cardBg} rounded-2xl border ${theme.cardBorder} overflow-hidden group hover:border-opacity-50 transition-colors`}
                                        >
                                            {item.image && (
                                                <div class="overflow-hidden">
                                                    <img
                                                        src={item.image}
                                                        alt={item.head}
                                                        class="w-full h-auto object-cover group-hover:scale-110 transition-transform duration-700"
                                                    />
                                                </div>
                                            )}
                                            <div class="p-6">
                                                <h3
                                                    class={`text-xl font-bold ${theme.accent} mb-2`}
                                                >
                                                    {item.head}
                                                </h3>
                                                <p
                                                    class={`${theme.textSub} leading-relaxed`}
                                                >
                                                    {item.body}
                                                </p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* 3. TYPE: STEPS */}
                            {section.type === "steps" && (
                                <div class="space-y-8">
                                    {section.items.map((item, stepIdx) => {
                                        const youtubeID = item.video
                                            ? getYouTubeID(item.video)
                                            : null;
                                        return (
                                            <div
                                                class={`flex flex-col md:flex-row gap-8 ${theme.cardBg} p-6 md:p-8 rounded-3xl border ${theme.cardBorder}`}
                                            >
                                                {/* Text Content */}
                                                <div class="md:w-1/2 space-y-4">
                                                    <span
                                                        class={`inline-block px-3 py-1 rounded ${theme.stepBadge} text-xs font-bold uppercase tracking-wider`}
                                                    >
                                                        Step {stepIdx + 1}
                                                    </span>
                                                    <h3
                                                        class={`text-2xl font-bold ${theme.textMain} leading-snug`}
                                                    >
                                                        {item.head}
                                                    </h3>
                                                    <p
                                                        class={`${theme.textSub} text-lg leading-relaxed`}
                                                    >
                                                        {item.body}
                                                    </p>
                                                </div>

                                                {/* Media Content */}
                                                <div class="md:w-1/2 space-y-4">
                                                    {item.image && (
                                                        <img
                                                            src={item.image}
                                                            alt={item.head}
                                                            class={`rounded-xl w-full border ${theme.cardBorder} shadow-lg`}
                                                            loading="lazy"
                                                        />
                                                    )}

                                                    {item.video &&
                                                        (youtubeID ? (
                                                            <div
                                                                class={`rounded-xl overflow-hidden border ${theme.cardBorder} shadow-lg aspect-video bg-black`}
                                                            >
                                                                <iframe
                                                                    width="100%"
                                                                    height="100%"
                                                                    src={`https://www.youtube.com/embed/${youtubeID}`}
                                                                    title={
                                                                        item.head
                                                                    }
                                                                    frameborder="0"
                                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                                    allowfullscreen
                                                                />
                                                            </div>
                                                        ) : (
                                                            <video
                                                                controls
                                                                class={`rounded-xl w-full border ${theme.cardBorder} shadow-lg bg-black aspect-video`}
                                                            >
                                                                <source
                                                                    src={
                                                                        item.video
                                                                    }
                                                                    type="video/mp4"
                                                                />
                                                                Your browser
                                                                does not support
                                                                the video tag.
                                                            </video>
                                                        ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* 4. TYPE: SPECS */}
                            {section.type === "specs" && (
                                <div
                                    class={`${theme.cardBg} rounded-2xl border ${theme.cardBorder} overflow-hidden`}
                                >
                                    <table class="w-full text-left">
                                        <tbody
                                            class={`divide-y ${theme.cardBorder.includes("white") ? "divide-white/10" : "divide-gray-200"}`}
                                        >
                                            {section.items.map((item) => (
                                                <tr class="hover:bg-white/5 transition-colors">
                                                    <th
                                                        class={`py-4 px-6 ${theme.accent} font-medium w-1/3 align-top`}
                                                    >
                                                        {item.label}
                                                    </th>
                                                    <td
                                                        class={`py-4 px-6 ${theme.textSub}`}
                                                    >
                                                        {item.value}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            {/* 5. TYPE: FAQ */}
                            {section.type === "faq" && (
                                <div class="grid gap-4">
                                    {section.items.map((item) => (
                                        <div
                                            class={`${theme.cardBg} p-6 rounded-2xl border ${theme.cardBorder} hover:opacity-90 transition-colors`}
                                        >
                                            <h3
                                                class={`text-lg font-bold ${theme.textMain} mb-3 flex items-start gap-3`}
                                            >
                                                <span
                                                    class={`${theme.accent} bg-current/10 px-2 rounded`}
                                                >
                                                    Q
                                                </span>
                                                {item.head}
                                            </h3>
                                            <p
                                                class={`${theme.textSub} pl-9 leading-relaxed`}
                                            >
                                                {item.body}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </section>
                    ))
                }

                {/* --- Contact / Support Section --- */}
                <section
                    class={`pt-16 border-t ${theme.cardBorder} text-center`}
                >
                    <h2 class={`text-2xl font-bold ${theme.textMain} mb-2`}>
                        ยังติดปัญหาการใช้งาน?
                    </h2>
                    <p class={`${theme.textSub} mb-8`}>
                        ทีมงาน Support พร้อมช่วยเหลือคุณทุกวัน (10:00 - 20:00)
                    </p>
                    <div class="flex justify-center gap-6">
                        <a
                            href="https://line.me/R/ti/p/%40example"
                            target="_blank"
                            class="flex items-center gap-3 px-6 py-3 bg-[#06C755] rounded-full text-white font-bold hover:brightness-110 transition-all shadow-lg shadow-[#06C755]/20"
                        >
                            <img
                                src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg"
                                class="w-6 h-6 filter brightness-0 invert"
                                alt="Line"
                            />
                            Line Support
                        </a>
                        <a
                            href="https://www.facebook.com/thecryptoclock"
                            target="_blank"
                            class="flex items-center gap-3 px-6 py-3 bg-[#1877F2] rounded-full text-white font-bold hover:brightness-110 transition-all shadow-lg shadow-[#1877F2]/20"
                        >
                            <img
                                src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg"
                                class="w-5 h-5 filter brightness-0 invert"
                                alt="Facebook"
                            />
                            Facebook
                        </a>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <Footer />
</Layout>
